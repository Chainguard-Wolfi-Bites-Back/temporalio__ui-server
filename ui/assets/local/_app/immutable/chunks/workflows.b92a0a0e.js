import{d as m,r as A,w as l}from"./index.1302fd9b.js";import{p as y}from"./stores.019bf0f9.js";import{t as I}from"./translate.ba73e37c.js";import{ac as T,n as f}from"./index.6779d4e2.js";import{a as F,b as B}from"./workflow-service.d2ea30c8.js";import{l as Q}from"./labs-mode.b6f5853d.js";import{l as q,m as P,n as k,o as R}from"./format-time.d81f945a.js";import{d as D,e as w,f as v,g as V,h as g,j as K}from"./is.5f877332.js";import{i as b}from"./format-date.f07a9180.js";import{u as N}from"./update-query-parameters.17b7fc61.js";import{r as W,a as d}from"./route-for-api.586d96ed.js";const O={workflowId:"WorkflowId",workflowType:"WorkflowType",timeRange:"StartTime",executionStatus:"ExecutionStatus",closeTime:"CloseTime",runId:"RunId"},L=t=>!(t===null||t===void 0||t===""||typeof t=="string"&&t==="undefined"),j=(t,r,o="=",s,e)=>{const a=O[t]??t;return r==="All"?"":e?`${a} ${r}`:q(r)||P(r)?s||T(F)?`${a} ${Q?o:">"} "${k(r)}"`:`${a} BETWEEN "${k(r)}" AND "${R()}"`:`${a}${o}"${r}"`},x=(t,r)=>t.map(({attribute:o,value:s,conditional:e,operator:a,parenthesis:i,customDate:n})=>{if(L(s)){let u=j(o,s,e,r,n);return i==="("?u=`(${u}`:i===")"&&(u=`${u})`),a&&(u=`${u} ${a} `),u}}).filter(Boolean),C=(t=[],r=!1)=>x(t,r).join("");var G=_;function _(t,r,o,s){var e,a,i;return function(){if(i=this,a=Array.prototype.slice.call(arguments),e&&(o||s))return;if(!o)return c(),e=setTimeout(u,r),e;e=setTimeout(c,r),t.apply(i,a);function u(){c(),t.apply(i,a)}function c(){clearTimeout(e),e=null}}}const z=t=>{const r=[],o=()=>{s&&(r.push(s),s="")};let s="",e=0;for(;e<t.length;){const a=t[e];if(D(a)){s+=a,o(),e++;continue}if(w(a)){const i=`${t[e]}${t[e+1]}`,n=`${t[e]}${t[e+1]}${t[e+2]}`;if(w(n)){o(),s+=n,e+=3;continue}else if(w(i)){o(),s+=i,e+=2;continue}else{o(),s+=a,e++;continue}}if(v(a)||V(a)){o(),e++;continue}s+=a,e++}return o(),r},J=t=>r=>r.toLowerCase()===t.toLowerCase(),$=(t,r)=>t[r+2],M=(t,r)=>t[r-2],U=J("Datetime"),h=()=>({attribute:"",value:"",operator:"",parenthesis:"",conditional:""}),Y={ExecutionStatus:"Keyword",StartTime:"Datetime",CloseTime:"Datetime",WorkflowId:"Keyword",WorkflowType:"Keyword",RunId:"Keyword"},Tt=(t,r=Y)=>{const o=z(t),s=[];let e=h();if(!t)return[];try{return o.forEach((a,i)=>{if(r[a])if(e.attribute=a,U(r[a])){const n=$(o,i),u=b(n);if(g(o[i+1])){const c=o[i+4],p=b(c);u&&p?(e.value=`BETWEEN "${n}" AND "${c}"`,e.customDate=!0):console.error("Error parsing Datetime field from query")}else u?e.value=n:console.error("Error parsing Datetime field from query")}else e.value=$(o,i);w(a)&&(e.conditional=a),D(a)&&(e.parenthesis=a),K(a)&&!g(M(o,i))&&(e.operator=a,s.push(e),e=h()),i===o.length-1&&(s.push(e),e=h())}),s}catch(a){return console.error("Error setting filter parameters: ",a),[]}},H=t=>{const r=t.filter(n=>n.attribute==="ExecutionStatus"&&n.value),o=t.filter(n=>n.attribute==="WorkflowId"&&n.value),s=t.filter(n=>n.attribute==="WorkflowType"&&n.value),e=t.filter(n=>n.attribute==="RunId"&&n.value),a=t.filter(n=>(n.attribute==="StartTime"||n.attribute==="CloseTime")&&n.value),i=[r,o,e,s,a].filter(n=>n.length);return i.forEach((n,u)=>{var c,p;n.length&&((c=i[u+1])!=null&&c.length)?n[n.length-1].operator="AND":n.length&&!((p=i[u+1])!=null&&p.length)&&(n[n.length-1].operator="")}),[...r,...o,...e,...s,...a]},S=t=>(t.forEach((r,o)=>{const s=t[o-1];s&&!s.operator&&(s.operator="AND"),t[o+1]||(r.operator=""),r.operator==="OR"&&(s==null?void 0:s.operator)!=="OR"?r.parenthesis="(":(s==null?void 0:s.operator)==="OR"&&r.operator!=="OR"?r.parenthesis=")":r.parenthesis=""}),t),Ft=G((t,r,o=!1)=>{const s=o?S(r):H(r),e=C(s);N({url:t,parameter:"query",value:e,allowEmpty:!1})},300),X=async(t,r,o=fetch)=>{let s=0,e=0;try{const a=W("workflows.count",{namespace:t});if(r){const i=d(a,{params:{query:r},onError:f,handleError:f,request:o}),n=d(a,{params:{query:""},onError:f,handleError:f,request:o}),[u,c]=await Promise.all([i,n]);e=parseInt((u==null?void 0:u.count)??"0"),s=parseInt(c==null?void 0:c.count)}else{const i=await d(a,{params:{},onError:f,handleError:f,request:o});s=parseInt(i==null?void 0:i.count)}}catch{}return{count:e,totalCount:s}},Dt=async({namespace:t,filters:r})=>{try{const o="GROUP BY ExecutionStatus",s=W("workflows.count",{namespace:t}),e=C(S(r)),{count:a,groups:i}=await d(s,{params:{query:`${e} ${o}`},notifyOnError:!1});return{count:a,groups:i}}catch{return{count:"0",groups:[]}}},Z=300,tt=async(t,r,o)=>{r.set(!0);try{await o()}catch(s){console.error(s)}t.set(!1),setTimeout(()=>{r.set(!1)},Z)},rt=m([y],([t])=>{var r,o,s;return Boolean((s=(o=(r=t.data)==null?void 0:r.systemInfo)==null?void 0:o.capabilities)==null?void 0:s.countGroupByExecutionStatus)}),et=l(0),ot=m([y],([t])=>{var r,o;return(o=(r=t.data)==null?void 0:r.settings)==null?void 0:o.hideWorkflowQueryErrors}),st=m([y],([t])=>t.params.namespace),at=m([y],([t])=>t.url.searchParams.get("query")),nt=m([st,at,et,F,ot],([t,r,o,s,e])=>({namespace:t,query:r,refresh:o,supportsAdvancedVisibility:s,hideWorkflowQueryErrors:e})),it=t=>{ft.set(t)},ut=t=>nt.subscribe(({namespace:r,query:o,supportsAdvancedVisibility:s,hideWorkflowQueryErrors:e})=>{tt(lt,ct,async()=>{const{workflows:a,error:i}=await B(r,{query:o});if(t(a),s&&!T(rt)){const n=await X(r,o);it(n)}i?e?E.set(I("workflows","workflows-error-querying")):E.set(i):E.set("")})}),Wt=l(""),ct=l(!0),lt=l(!0),ft=l({count:0,totalCount:0}),E=l(""),Ct=A([],ut),St=l("");export{St as a,Tt as b,C as c,S as d,h as e,ct as f,ft as g,Dt as h,E as i,G as j,Ct as k,lt as l,rt as m,et as r,z as t,Ft as u,Wt as w};
