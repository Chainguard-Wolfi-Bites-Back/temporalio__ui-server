import{z as E}from"./scheduler.yuwC4fMQ.js";import{p as v}from"./stores.fqLSXe6U.js";import{t as j}from"./translate.eu_ZgPaL.js";import{e as D,h as K}from"./decode-payload.rLspfNZC.js";import{f as N}from"./screaming-enums.NBZzZ07O.js";import{w as _}from"./write-actions-are-allowed.8FHoGbZo.js";import{s as L}from"./simplify-attributes.vxftMF3R.js";import{l as J,b as G}from"./data-encoder-config.M8L8jBcS.js";import{B as H}from"./prod-browser.6V4A_NcJ.js";import{b as M,p as X,a as d,r as l,c as Y,d as Z,e as oo}from"./route-for-api.qh0xco3r.js";import{s as x}from"./parse-with-big-int.jPY5aC0s.js";import{d as I}from"./entry.4GwfGVYr.js";import{i as R}from"./version-check.Tmw6106D.js";import{c as $,t as to}from"./versions.sNzKrIv2.js";import{i as no,c as ro,t as C,d as eo}from"./format-time.uKY6gqY0.js";import{v as io}from"./toaster.a4OJAZIZ.js";const ao=(o=[])=>o.map(t=>{const n=L(t,!0),r=t.activityId;return{...n,id:r}}),co=o=>!o||!o.indexedFields?{}:{indexedFields:Object.entries(o.indexedFields).reduce((n,[r,e])=>({...n,[r]:D(e)}),{})},p=o=>{var b,T,g,S,W,A,O;const t=co(o.workflowExecutionInfo.searchAttributes),n=o.workflowExecutionInfo.type.name,r=o.workflowExecutionInfo.execution.workflowId,e=o.workflowExecutionInfo.execution.runId,i=o.workflowExecutionInfo.startTime,f=o.workflowExecutionInfo.closeTime,c=o.workflowExecutionInfo.executionTime,s=N(o.workflowExecutionInfo.status),u=s==="Running",w=o.workflowExecutionInfo.historyLength,y=o.workflowExecutionInfo.historySizeBytes,a=`/workflows/${r}/${e}`,m=((T=(b=o==null?void 0:o.executionConfig)==null?void 0:b.taskQueue)==null?void 0:T.name)||((g=o==null?void 0:o.workflowExecutionInfo)==null?void 0:g.taskQueue),k=(S=o==null?void 0:o.workflowExecutionInfo)==null?void 0:S.mostRecentWorkerVersionStamp,h=(W=o==null?void 0:o.workflowExecutionInfo)==null?void 0:W.parentNamespaceId,z=(A=o==null?void 0:o.workflowExecutionInfo)==null?void 0:A.parentExecution,B=o.workflowExecutionInfo.stateTransitionCount,q=(O=o.executionConfig)==null?void 0:O.defaultWorkflowTaskTimeout,Q=ao(o.pendingActivities),U=(o==null?void 0:o.pendingChildren)??[];return{name:n,id:r,runId:e,startTime:i,endTime:f,executionTime:c,status:s,historyEvents:w,historySizeBytes:y,searchAttributes:t,url:a,taskQueue:m,mostRecentWorkerVersionStamp:k,pendingActivities:Q,pendingChildren:U,parentNamespaceId:h,parent:z,stateTransitionCount:B,isRunning:u,defaultWorkflowTaskTimeout:q,get canBeTerminated(){return u&&_()}}},P=o=>(o.executions||[]).map(t=>p({workflowExecutionInfo:t})),so=o=>window.btoa(encodeURIComponent(o).replace(/%([0-9A-F]{2})/g,(t,n)=>String.fromCharCode(parseInt(n,16)))),F=(o,t=H)=>t?so(o):o,fo=(o,t)=>{var n;return((n=o==null?void 0:o.visibilityStore)==null?void 0:n.includes("elasticsearch"))||R(t,"1.19")},uo=o=>{var t;return(t=o==null?void 0:o.visibilityStore)==null?void 0:t.includes("elasticsearch")},V=I([v],([o])=>{var t,n,r;return(r=(n=(t=o.data)==null?void 0:t.settings)==null?void 0:n.runtimeEnvironment)==null?void 0:r.isCloud}),lo=I([$,to,V],([o,t,n])=>fo(o,t)||n);I([$,V],([o,t])=>uo(o)||t);const wo={workflowId:"WorkflowId",workflowType:"WorkflowType",timeRange:"StartTime",executionStatus:"ExecutionStatus",closeTime:"CloseTime"},mo=["workflowId","workflowType","timeRange","executionStatus","closeTime"],ko=o=>!(o===null||o===void 0||o===""||typeof o=="string"&&o==="undefined"),yo=o=>{if(typeof o!="string")return!1;for(const t of mo)if(t===o)return!0;return!1},ho=(o,t,n)=>{const r=wo[o];return t==="All"?"":no(t)||ro(t)?n||E(lo)?`${r} > "${C(t)}"`:`${r} BETWEEN "${C(t)}" AND "${eo()}"`:`${r}="${t}"`},Eo=(o,t)=>Object.entries(o).map(([n,r])=>{if(yo(n)&&ko(r))return ho(n,r,t)}).filter(Boolean),xo=(o,t=!1)=>Eo(o,t).join(" and "),Io=async(o,t,n=fetch,r=!1)=>{const e=t.query||xo(t,r);let i;try{i=decodeURIComponent(e)}catch{i=e}const f=r?"workflows.archived":"workflows";let c="";const s=a=>{var m,k;Y(a),(m=a==null?void 0:a.body)!=null&&m.message||a!=null&&a.status?c=((k=a==null?void 0:a.body)==null?void 0:k.message)??`Error fetching workflows: ${a.status}: ${a.statusText}`:c="Error fetching workflows: Server failed to respond"},u=l(f,{namespace:o}),{executions:w,nextPageToken:y}=await d(u,{params:{query:i},onError:s,handleError:s,request:n})??{executions:[],nextPageToken:""};return{workflows:P({executions:w}),nextPageToken:String(y),error:c}},Bo=async({namespace:o,workflowId:t,url:n},r=fetch)=>{var w;const e="workflows",i=n??M(o),f=X(e,{namespace:o}),c=i+f,{executions:s}=await d(c,{params:{query:`WorkflowId="${t}"`,pageSize:"1"},request:r})??{executions:[]},u=(w=P({executions:s}))==null?void 0:w[0];return{runId:u==null?void 0:u.runId}},qo=async(o,t=fetch,n=!1)=>{const r=n?"workflows.archived":"workflows";let e=!0;const i=c=>{(Z(c)||oo(c))&&(e=!1)},f=l(r,{namespace:o});return await d(f,{params:{pageSize:"1"},onError:i,handleError:i,request:t}),{authorized:e}},Qo=async(o,t,n=fetch)=>Io(o,t,n,!0);async function Uo(o,t=fetch){const n=l("workflow",{namespace:o.namespace,workflowId:o.workflowId});return d(n,{request:t,notifyOnError:!1,params:{"execution.runId":o.runId}}).then(r=>({workflow:p(r)})).catch(r=>({error:r}))}async function jo({workflow:o,namespace:t,reason:n,identity:r}){const e=l("workflow.terminate",{namespace:t,workflowId:o.id});return await d(e,{options:{method:"POST",body:x({reason:n,...r&&{identity:r}})},notifyOnError:!1,params:{"execution.runId":o.runId}})}async function Do({namespace:o,workflowId:t,runId:n},r=fetch){const e=l("workflow.cancel",{namespace:o,workflowId:t});return d(e,{request:r,notifyOnError:!1,options:{method:"POST"},params:{"execution.runId":n}})}async function Ko({namespace:o,workflowId:t,runId:n,signalName:r,signalInput:e,settings:i,accessToken:f}){var a,m,k;const c=l("workflow.signal",{namespace:o,workflowId:t,signalName:r});let s=null;if(e)if((a=i==null?void 0:i.codec)!=null&&a.endpoint){const h=await K({payloads:{payloads:[JSON.parse(e)]},namespace:o,settings:i,accessToken:f,encode:!0});if(E(J)==="error")throw new Error(E(G)||j("common.encode-failed"));s=(h==null?void 0:h.payloads)??null}else s=[{metadata:{encoding:F("json/plain")},data:F(e)}];const u=((k=(m=E(v).data)==null?void 0:m.settings)==null?void 0:k.version)??"",y=R(u,"2.22")?{signalName:r,workflowExecution:{workflowId:t,runId:n},input:{payloads:s}}:{signalName:r,input:{payloads:s},params:{"execution.runId":n}};return d(c,{notifyOnError:!1,options:{method:"POST",body:x(y)}})}async function No({namespace:o,workflowId:t,runId:n,eventId:r,reason:e,resetReapplyType:i}){const f=l("workflow.reset",{namespace:o,workflowId:t}),c={workflowExecution:{workflowId:t,runId:n},workflowTaskFinishEventId:r,resetReapplyType:i,requestId:io(),reason:e};return d(f,{notifyOnError:!1,options:{method:"POST",body:x(c)},params:{"execution.runId":n}})}async function _o(o,t=fetch){const n=e=>{console.error(e)},r=l("workflow",o);return d(r,{request:t,onError:n,handleError:n}).then(p)}export{qo as a,Io as b,Qo as c,_o as d,jo as e,Bo as f,Do as g,Ko as h,Uo as i,V as j,No as r,lo as s,xo as t};
