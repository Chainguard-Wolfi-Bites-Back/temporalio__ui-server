import{aj as s}from"./index.df672b57.js";import{p as T}from"./stores.2e94b3b6.js";import{t as W}from"./translate.fa4eeabe.js";import{s as O,b as B,c as E,o as j,p as F,i as L}from"./data-encoder-config.b0c37890.js";import{h as m,k as R}from"./has.d2b0b725.js";import{v as _,a as w}from"./is-http.ffee6a9d.js";import{s as x,p as b}from"./parse-with-big-int.b2dd742c.js";import{a as z}from"./auth-user.c1d54a3b.js";async function H({payloads:o,namespace:e,settings:c,accessToken:r,encode:d=!1}){var C,k,P;const f=(C=c==null?void 0:c.codec)==null?void 0:C.endpoint,n=(k=c==null?void 0:c.codec)==null?void 0:k.passAccessToken,a=(P=c==null?void 0:c.codec)==null?void 0:P.includeCredentials,t={"Content-Type":"application/json","X-Namespace":e};if(n)if(_(f))t.Authorization=`Bearer ${r}`;else return O(),o;const i=a?{headers:t,credentials:"include",method:"POST",body:x(o)}:{headers:t,method:"POST",body:x(o)};return fetch(f+(d?"/encode":"/decode"),i).then(h=>{if(m(h,"ok")&&!h.ok)throw{statusCode:h.status,statusText:h.statusText,response:h,message:d?W("common.encode-failed"):W("common.decode-failed")};return h.json()}).then(h=>(B(),h)).catch(h=>(O(h),o))}const J=(o,e=E,c=j)=>{var d;return s(c)&&s(e)||((d=o==null?void 0:o.codec)==null?void 0:d.endpoint)||s(e)||""},K=(o,e=F,c=E,r=j)=>{var n,a;const d=s(r)&&s(c),f=(n=o==null?void 0:o.codec)!=null&&n.endpoint?!!((a=o==null?void 0:o.codec)!=null&&a.passAccessToken):!!s(e);return d?!!s(e):f},N=(o,e=L,c=E,r=j)=>{var n,a;const d=s(r)&&s(c),f=(n=o==null?void 0:o.codec)!=null&&n.endpoint?!!((a=o==null?void 0:o.codec)!=null&&a.includeCredentials):!!s(e);return d?!!s(e):f},S=o=>Array.isArray(o)?o:[o];function u(o,e=!0){var r;if(o===null)return o;const c=w(String(((r=o==null?void 0:o.metadata)==null?void 0:r.encoding)??""));if(o!=null&&o.metadata&&(o.metadata.encodingDecoded=c),c!=null&&c.startsWith("json/"))try{const d=b(w(String((o==null?void 0:o.data)??"")));return e?d:{...o,data:d}}catch(d){console.warn("Could not parse payload: ",d)}return c==="binary/null"?e?null:{...o,data:null}:o}const A=(o,e=!0)=>{if(m(o,"searchAttributes")&&m(o.searchAttributes,"indexedFields")){const c=o.searchAttributes.indexedFields;Object.entries(c).forEach(([r,d])=>{c[r]=u(d,e)})}else if(m(o,"searchAttributes")){const c=o.searchAttributes;Object.entries(c).forEach(([r,d])=>{c[r]=u(d,e)})}if(m(o,"memo")&&m(o.memo,"fields")){const c=o.memo.fields;Object.entries(c).forEach(([r,d])=>{c[r]=u(d,e)})}if(m(o,"header")&&m(o.header,"fields")){const c=o.header.fields;Object.entries(c).forEach(([r,d])=>{c[r]=u(d,e)})}if(m(o,"queryResult")){const c=o==null?void 0:o.queryResult;Object.entries(c).forEach(([r,d])=>{c[r]=u(d,e)})}return o},q=(o,e,c)=>async(r,d=!0)=>{var f;if((f=e==null?void 0:e.codec)!=null&&f.endpoint){const n=await H({payloads:{payloads:r},namespace:o,settings:e,accessToken:c});return((n==null?void 0:n.payloads)??[]).map(a=>u(a,d))}else return r.map(n=>u(n,d))},p=(o,...e)=>{for(const c of e)if(o===c)return!0;return!1},I=async(o,e=s(T).params.namespace,c=s(T).data.settings,r=s(z).accessToken)=>{const d=J(c),f=K(c),n=N(c),a={...c,codec:{...c==null?void 0:c.codec,endpoint:d,passAccessToken:f,includeCredentials:n}},t=q(e,a,r);if(o)for(const i of Object.keys(o))if(p(i,"payloads","encodedAttributes")&&o[i]){const l=S(o[i]),C=await t(l);o[i]=p(i,"encodedAttributes")?C[0]:C}else{const l=o[i];R(l)&&(o[i]=await I(l,e,c,r))}return o},U=async(o,e,c,r,d=!0)=>{if(!o)return o;const f=q(e,c,r),n={...o};if(o)for(const a of Object.keys(n))if(p(a,"payloads","encodedAttributes")&&n[a]){const t=S(n[a]),i=await f(t,d);n[a]=p(a,"encodedAttributes")?i[0]:i}else{const t=n[a];R(t)&&(n[a]=await U(t,e,c,r,d))}return n},v=async({attributes:o,namespace:e,settings:c,accessToken:r})=>await I(o,e,c,r);export{u as a,H as b,v as c,A as d,K as e,N as f,J as g,U as h};
