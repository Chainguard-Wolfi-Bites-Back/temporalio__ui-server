import{z as m}from"./scheduler.LRpOgQOC.js";import{p as O}from"./stores.sE116scP.js";import{A as h}from"./workflow-actions.-K4W_iAA.js";import{h as G}from"./decode-payload.zPexWyH2.js";import{f as H}from"./screaming-enums.NBZzZ07O.js";import{w as J}from"./write-actions-are-allowed.8FAdLoCH.js";import{s as M}from"./simplify-attributes.5loNQFMU.js";import{d as I}from"./entry.ZRISLbzG.js";import{i as P,m as X}from"./version-check.HLZIw2tw.js";import{c as $,t as V}from"./versions.5W-ZxMjB.js";import{a as q}from"./auth-user.aICbx4pz.js";import{e as Y}from"./encode-payload.WRhqRgp_.js";import{b as Z,p as oo,a as d,r as w,c as to,d as no,e as eo}from"./route-for-api.qWASSnmW.js";import{s as g}from"./parse-with-big-int.e3oI4SEy.js";import{i as ro,b as io,t as v,c as ao}from"./format-time.9mIRALNp.js";import{t as k}from"./translate.HrioCK44.js";import{v as so}from"./toaster.LjgC8rxN.js";const co=(o=[])=>o.map(t=>{const n=M(t,!0),e=t.activityId;return{...n,id:e}}),fo=o=>!o||!o.indexedFields?{}:{indexedFields:Object.entries(o.indexedFields).reduce((n,[e,r])=>({...n,[e]:G(r)}),{})},T=o=>{var b,W,A,S,R,F,C;const t=fo(o.workflowExecutionInfo.searchAttributes),n=o.workflowExecutionInfo.memo,e=o.workflowExecutionInfo.type.name,r=o.workflowExecutionInfo.execution.workflowId,i=o.workflowExecutionInfo.execution.runId,c=o.workflowExecutionInfo.startTime,a=o.workflowExecutionInfo.closeTime,l=o.workflowExecutionInfo.executionTime,f=H(o.workflowExecutionInfo.status),u=f==="Running",E=o.workflowExecutionInfo.historyLength,s=o.workflowExecutionInfo.historySizeBytes,y=`/workflows/${r}/${i}`,x=((W=(b=o==null?void 0:o.executionConfig)==null?void 0:b.taskQueue)==null?void 0:W.name)||((A=o==null?void 0:o.workflowExecutionInfo)==null?void 0:A.taskQueue),Q=(S=o==null?void 0:o.workflowExecutionInfo)==null?void 0:S.mostRecentWorkerVersionStamp,U=(R=o==null?void 0:o.workflowExecutionInfo)==null?void 0:R.parentNamespaceId,j=(F=o==null?void 0:o.workflowExecutionInfo)==null?void 0:F.parentExecution,K=o.workflowExecutionInfo.stateTransitionCount,D=(C=o.executionConfig)==null?void 0:C.defaultWorkflowTaskTimeout,L=co(o.pendingActivities),_=(o==null?void 0:o.pendingChildren)??[];return{name:e,id:r,runId:i,startTime:c,endTime:a,executionTime:l,status:f,historyEvents:E,historySizeBytes:s,searchAttributes:t,memo:n,url:y,taskQueue:x,mostRecentWorkerVersionStamp:Q,pendingActivities:L,pendingChildren:_,parentNamespaceId:U,parent:j,stateTransitionCount:K,isRunning:u,defaultWorkflowTaskTimeout:D,get canBeTerminated(){return u&&J()}}},z=o=>(o.executions||[]).map(t=>T({workflowExecutionInfo:t})),lo=(o,t)=>{var n;return((n=o==null?void 0:o.visibilityStore)==null?void 0:n.includes("elasticsearch"))||P(t,"1.19")},uo=o=>{var t;return(t=o==null?void 0:o.visibilityStore)==null?void 0:t.includes("elasticsearch")},p=I([O],([o])=>{var t,n,e;return(e=(n=(t=o.data)==null?void 0:t.settings)==null?void 0:n.runtimeEnvironment)==null?void 0:e.isCloud}),wo=I([$,V,p],([o,t,n])=>lo(o,t)||n);I([$,p],([o,t])=>uo(o)||t);const mo={workflowId:"WorkflowId",workflowType:"WorkflowType",timeRange:"StartTime",executionStatus:"ExecutionStatus",closeTime:"CloseTime"},ko=["workflowId","workflowType","timeRange","executionStatus","closeTime"],ho=o=>!(o===null||o===void 0||o===""||typeof o=="string"&&o==="undefined"),yo=o=>{if(typeof o!="string")return!1;for(const t of ko)if(t===o)return!0;return!1},xo=(o,t,n)=>{const e=mo[o];return t==="All"?"":ro(t)||io(t)?n||m(wo)?`${e} > "${v(t)}"`:`${e} BETWEEN "${v(t)}" AND "${ao()}"`:`${e}="${t}"`},Eo=(o,t)=>Object.entries(o).map(([n,e])=>{if(yo(n)&&ho(e))return xo(n,e,t)}).filter(Boolean),Io=(o,t=!1)=>Eo(o,t).join(" and ");function go(o){console.error("Unhandled action:",o)}const To=(o,t)=>{let n;switch(o){case h.Cancel:n=k("workflows.canceled");break;case h.Reset:n=k("workflows.reset");break;case h.Terminate:n=k("workflows.terminated");break;default:go(o)}return t?k("workflows.workflow-action-reason-placeholder-with-email",{action:n,email:t}):k("workflows.workflow-action-reason-placeholder",{action:n})},N=({action:o,reason:t,email:n})=>{const e=To(o,n);return t?[t.trim(),e].join(" "):e},B=async(o,t,n=fetch,e=!1)=>{const r=t.query||Io(t,e);let i;try{i=decodeURIComponent(r)}catch{i=r}const c=e?"workflows.archived":"workflows";let a="";const l=s=>{var y,x;to(s),(y=s==null?void 0:s.body)!=null&&y.message||s!=null&&s.status?a=((x=s==null?void 0:s.body)==null?void 0:x.message)??`Error fetching workflows: ${s.status}: ${s.statusText}`:a="Error fetching workflows: Server failed to respond"},f=w(c,{namespace:o}),{executions:u,nextPageToken:E}=await d(f,{params:{query:i},onError:l,handleError:l,request:n})??{executions:[],nextPageToken:""};return{workflows:z({executions:u}),nextPageToken:String(E),error:a}},Qo=async({namespace:o,workflowId:t,url:n},e=fetch)=>{var u;const r="workflows",i=n??Z(o),c=oo(r,{namespace:o}),a=i+c,{executions:l}=await d(a,{params:{query:`WorkflowId="${t}"`,pageSize:"1"},request:e})??{executions:[]},f=(u=z({executions:l}))==null?void 0:u[0];return{runId:f==null?void 0:f.runId}},Uo=async(o,t=fetch,n=!1)=>{const e=n?"workflows.archived":"workflows";let r=!0;const i=a=>{(no(a)||eo(a))&&(r=!1)},c=w(e,{namespace:o});return await d(c,{params:{pageSize:"1"},onError:i,handleError:i,request:t}),{authorized:r}},jo=async(o,t,n=fetch)=>B(o,t,n,!0);async function Ko(o,t=fetch){const n=w("workflow",{namespace:o.namespace,workflowId:o.workflowId});return d(n,{request:t,notifyOnError:!1,params:{"execution.runId":o.runId}}).then(e=>({workflow:T(e)})).catch(e=>({error:e}))}async function Do({workflow:o,namespace:t,reason:n}){const e=w("workflow.terminate",{namespace:t,workflowId:o.id}),r=m(q).email,i=N({reason:n,action:h.Terminate,email:r});return await d(e,{options:{method:"POST",body:g({reason:i,...r&&{identity:r}})},notifyOnError:!1,params:{"execution.runId":o.runId}})}async function Lo({namespace:o,workflow:{id:t,runId:n}},e=fetch){const r=w("workflow.cancel",{namespace:o,workflowId:t});return d(r,{request:e,notifyOnError:!1,options:{method:"POST"},params:{"execution.runId":n}})}async function _o({namespace:o,workflow:{id:t,runId:n},name:e,input:r}){const i=w("workflow.signal",{namespace:o,workflowId:t,signalName:e}),c=await Y(r),a=m(O).data.settings,l=(a==null?void 0:a.version)??"",u=P(l,"2.22")?{signalName:e,workflowExecution:{workflowId:t,runId:n},input:{payloads:c}}:{signalName:e,input:{payloads:c},params:{"execution.runId":n}};return d(i,{notifyOnError:!1,options:{method:"POST",body:g(u)}})}async function Go({namespace:o,workflow:{id:t,runId:n},eventId:e,reason:r,reapplyType:i}){const c=w("workflow.reset",{namespace:o,workflowId:t}),a=m(q).email,l=N({action:h.Reset,reason:r,email:a}),f={workflowExecution:{workflowId:t,runId:n},workflowTaskFinishEventId:e,resetReapplyType:i,requestId:so(),reason:l};return d(c,{notifyOnError:!1,options:{method:"POST",body:g(f)},params:{"execution.runId":n}})}async function Ho(o,t=fetch){const n=r=>{console.error(r)},e=w("workflow",o);return d(e,{request:t,onError:n,handleError:n}).then(T)}async function Jo(o,t){if(!(m(p)||X("1.23",m(V))))return[];try{const{workflows:e}=await B(o,{query:`ParentWorkflowId = "${t}"`});return e}catch{return[]}}export{Uo as a,B as b,Lo as c,Jo as d,jo as e,Qo as f,Io as g,_o as h,Ko as i,Ho as j,To as k,p as l,Go as r,wo as s,Do as t};
