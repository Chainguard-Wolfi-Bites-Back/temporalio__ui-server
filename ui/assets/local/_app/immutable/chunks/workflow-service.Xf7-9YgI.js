import{z as d}from"./scheduler.yuwC4fMQ.js";import{p as I}from"./stores.f3t7WWBZ.js";import{t as h}from"./translate.eu_ZgPaL.js";import{A as g}from"./workflow-actions.-K4W_iAA.js";import{e as _,h as L}from"./decode-payload.8TKwBQrj.js";import{f as J}from"./screaming-enums.NBZzZ07O.js";import{w as G}from"./write-actions-are-allowed.CnTp9HoZ.js";import{s as H}from"./simplify-attributes.sHIxaA7H.js";import{a as p}from"./auth-user.ZGFnAnjW.js";import{l as M,b as X}from"./data-encoder-config.AHMY1WYk.js";import{B as Y}from"./prod-browser.6V4A_NcJ.js";import{b as Z,p as oo,a as u,r as w,c as to,d as no,e as eo}from"./route-for-api.fA0qgCTl.js";import{s as T}from"./parse-with-big-int.e3oI4SEy.js";import{d as b}from"./entry.o4SLT-vb.js";import{i as V}from"./version-check.Tmw6106D.js";import{c as z,t as ro}from"./versions.hj0p9QcA.js";import{i as io,c as ao,t as P,d as so}from"./format-time.p0flJh4T.js";import{v as co}from"./toaster.b0r33BuH.js";const fo=(o=[])=>o.map(t=>{const n=H(t,!0),e=t.activityId;return{...n,id:e}}),lo=o=>!o||!o.indexedFields?{}:{indexedFields:Object.entries(o.indexedFields).reduce((n,[e,r])=>({...n,[e]:_(r)}),{})},S=o=>{var W,A,R,C,O,F,v;const t=lo(o.workflowExecutionInfo.searchAttributes),n=o.workflowExecutionInfo.type.name,e=o.workflowExecutionInfo.execution.workflowId,r=o.workflowExecutionInfo.execution.runId,s=o.workflowExecutionInfo.startTime,c=o.workflowExecutionInfo.closeTime,i=o.workflowExecutionInfo.executionTime,l=J(o.workflowExecutionInfo.status),f=l==="Running",m=o.workflowExecutionInfo.historyLength,E=o.workflowExecutionInfo.historySizeBytes,a=`/workflows/${e}/${r}`,k=((A=(W=o==null?void 0:o.executionConfig)==null?void 0:W.taskQueue)==null?void 0:A.name)||((R=o==null?void 0:o.workflowExecutionInfo)==null?void 0:R.taskQueue),y=(C=o==null?void 0:o.workflowExecutionInfo)==null?void 0:C.mostRecentWorkerVersionStamp,x=(O=o==null?void 0:o.workflowExecutionInfo)==null?void 0:O.parentNamespaceId,q=(F=o==null?void 0:o.workflowExecutionInfo)==null?void 0:F.parentExecution,Q=o.workflowExecutionInfo.stateTransitionCount,j=(v=o.executionConfig)==null?void 0:v.defaultWorkflowTaskTimeout,D=fo(o.pendingActivities),K=(o==null?void 0:o.pendingChildren)??[];return{name:n,id:e,runId:r,startTime:s,endTime:c,executionTime:i,status:l,historyEvents:m,historySizeBytes:E,searchAttributes:t,url:a,taskQueue:k,mostRecentWorkerVersionStamp:y,pendingActivities:D,pendingChildren:K,parentNamespaceId:x,parent:q,stateTransitionCount:Q,isRunning:f,defaultWorkflowTaskTimeout:j,get canBeTerminated(){return f&&G()}}},B=o=>(o.executions||[]).map(t=>S({workflowExecutionInfo:t})),uo=o=>window.btoa(encodeURIComponent(o).replace(/%([0-9A-F]{2})/g,(t,n)=>String.fromCharCode(parseInt(n,16)))),$=(o,t=Y)=>t?uo(o):o,wo=(o,t)=>{var n;return((n=o==null?void 0:o.visibilityStore)==null?void 0:n.includes("elasticsearch"))||V(t,"1.19")},mo=o=>{var t;return(t=o==null?void 0:o.visibilityStore)==null?void 0:t.includes("elasticsearch")},N=b([I],([o])=>{var t,n,e;return(e=(n=(t=o.data)==null?void 0:t.settings)==null?void 0:n.runtimeEnvironment)==null?void 0:e.isCloud}),ko=b([z,ro,N],([o,t,n])=>wo(o,t)||n);b([z,N],([o,t])=>mo(o)||t);const yo={workflowId:"WorkflowId",workflowType:"WorkflowType",timeRange:"StartTime",executionStatus:"ExecutionStatus",closeTime:"CloseTime"},ho=["workflowId","workflowType","timeRange","executionStatus","closeTime"],Eo=o=>!(o===null||o===void 0||o===""||typeof o=="string"&&o==="undefined"),xo=o=>{if(typeof o!="string")return!1;for(const t of ho)if(t===o)return!0;return!1},go=(o,t,n)=>{const e=yo[o];return t==="All"?"":io(t)||ao(t)?n||d(ko)?`${e} > "${P(t)}"`:`${e} BETWEEN "${P(t)}" AND "${so()}"`:`${e}="${t}"`},Io=(o,t)=>Object.entries(o).map(([n,e])=>{if(xo(n)&&Eo(e))return go(n,e,t)}).filter(Boolean),po=(o,t=!1)=>Io(o,t).join(" and ");function To(o){console.error("Unhandled action:",o)}const bo=(o,t)=>{let n;switch(o){case g.Cancel:n=h("workflows.canceled");break;case g.Reset:n=h("workflows.reset");break;case g.Terminate:n=h("workflows.terminated");break;default:To(o)}return t?h("workflows.workflow-action-reason-placeholder-with-email",{action:n,email:t}):h("workflows.workflow-action-reason-placeholder",{action:n})},U=({action:o,reason:t,email:n})=>{const e=bo(o,n);return t?[t.trim(),e].join(" "):e},So=async(o,t,n=fetch,e=!1)=>{const r=t.query||po(t,e);let s;try{s=decodeURIComponent(r)}catch{s=r}const c=e?"workflows.archived":"workflows";let i="";const l=a=>{var k,y;to(a),(k=a==null?void 0:a.body)!=null&&k.message||a!=null&&a.status?i=((y=a==null?void 0:a.body)==null?void 0:y.message)??`Error fetching workflows: ${a.status}: ${a.statusText}`:i="Error fetching workflows: Server failed to respond"},f=w(c,{namespace:o}),{executions:m,nextPageToken:E}=await u(f,{params:{query:s},onError:l,handleError:l,request:n})??{executions:[],nextPageToken:""};return{workflows:B({executions:m}),nextPageToken:String(E),error:i}},Ko=async({namespace:o,workflowId:t,url:n},e=fetch)=>{var m;const r="workflows",s=n??Z(o),c=oo(r,{namespace:o}),i=s+c,{executions:l}=await u(i,{params:{query:`WorkflowId="${t}"`,pageSize:"1"},request:e})??{executions:[]},f=(m=B({executions:l}))==null?void 0:m[0];return{runId:f==null?void 0:f.runId}},_o=async(o,t=fetch,n=!1)=>{const e=n?"workflows.archived":"workflows";let r=!0;const s=i=>{(no(i)||eo(i))&&(r=!1)},c=w(e,{namespace:o});return await u(c,{params:{pageSize:"1"},onError:s,handleError:s,request:t}),{authorized:r}},Lo=async(o,t,n=fetch)=>So(o,t,n,!0);async function Jo(o,t=fetch){const n=w("workflow",{namespace:o.namespace,workflowId:o.workflowId});return u(n,{request:t,notifyOnError:!1,params:{"execution.runId":o.runId}}).then(e=>({workflow:S(e)})).catch(e=>({error:e}))}async function Go({workflow:o,namespace:t,reason:n}){const e=w("workflow.terminate",{namespace:t,workflowId:o.id}),r=d(p).email,s=U({reason:n,action:g.Terminate,email:r});return await u(e,{options:{method:"POST",body:T({reason:s,...r&&{identity:r}})},notifyOnError:!1,params:{"execution.runId":o.runId}})}async function Ho({namespace:o,workflow:{id:t,runId:n}},e=fetch){const r=w("workflow.cancel",{namespace:o,workflowId:t});return u(r,{request:e,notifyOnError:!1,options:{method:"POST"},params:{"execution.runId":n}})}async function Mo({namespace:o,workflow:{id:t,runId:n},name:e,input:r}){var a,k,y;const s=w("workflow.signal",{namespace:o,workflowId:t,signalName:e});let c=null;const i=d(I).data.settings,l=d(p).accessToken;if(r)if((a=i==null?void 0:i.codec)!=null&&a.endpoint){const x=await L({payloads:{payloads:[JSON.parse(r)]},namespace:o,settings:i,accessToken:l,encode:!0});if(d(M)==="error")throw new Error(d(X)||h("common.encode-failed"));c=(x==null?void 0:x.payloads)??null}else c=[{metadata:{encoding:$("json/plain")},data:$(r)}];const f=((y=(k=d(I).data)==null?void 0:k.settings)==null?void 0:y.version)??"",E=V(f,"2.22")?{signalName:e,workflowExecution:{workflowId:t,runId:n},input:{payloads:c}}:{signalName:e,input:{payloads:c},params:{"execution.runId":n}};return u(s,{notifyOnError:!1,options:{method:"POST",body:T(E)}})}async function Xo({namespace:o,workflow:{id:t,runId:n},eventId:e,reason:r,reapplyType:s}){const c=w("workflow.reset",{namespace:o,workflowId:t}),i=d(p).email,l=U({action:g.Reset,reason:r,email:i}),f={workflowExecution:{workflowId:t,runId:n},workflowTaskFinishEventId:e,resetReapplyType:s,requestId:co(),reason:l};return u(c,{notifyOnError:!1,options:{method:"POST",body:T(f)},params:{"execution.runId":n}})}async function Yo(o,t=fetch){const n=r=>{console.error(r)},e=w("workflow",o);return u(e,{request:t,onError:n,handleError:n}).then(S)}export{_o as a,So as b,Ho as c,Lo as d,po as e,Ko as f,Yo as g,Mo as h,Jo as i,bo as j,N as k,Xo as r,ko as s,Go as t};
