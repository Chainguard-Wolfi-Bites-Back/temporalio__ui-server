import{z as s}from"./scheduler.yuwC4fMQ.js";import{p as T}from"./stores.sWpEPH_T.js";import{t as W}from"./translate.eu_ZgPaL.js";import{s as O,a as B,c as E,o as P,p as F,i as L}from"./data-encoder-config.8qJzCcgo.js";import{h as m,a as R}from"./has.GKfowTHT.js";import{v as _,a as w}from"./is-http.Y_1dIkbJ.js";import{s as x,p as z}from"./parse-with-big-int.e3oI4SEy.js";import{a as H}from"./auth-user.iBpyjUrJ.js";async function J({payloads:o,namespace:e,settings:c,accessToken:r,encode:d=!1}){var C,j,k;const f=(C=c==null?void 0:c.codec)==null?void 0:C.endpoint,a=(j=c==null?void 0:c.codec)==null?void 0:j.passAccessToken,n=(k=c==null?void 0:c.codec)==null?void 0:k.includeCredentials,t={"Content-Type":"application/json","X-Namespace":e};if(a)if(_(f))t.Authorization=`Bearer ${r}`;else return O(),o;const i=n?{headers:t,credentials:"include",method:"POST",body:x(o)}:{headers:t,method:"POST",body:x(o)};return fetch(f+(d?"/encode":"/decode"),i).then(h=>{if(m(h,"ok")&&!h.ok)throw{statusCode:h.status,statusText:h.statusText,response:h,message:d?W("common.encode-failed"):W("common.decode-failed")};return h.json()}).then(h=>(B(),h)).catch(h=>(O(h),o))}const K=(o,e=E,c=P)=>{var d;return s(c)&&s(e)||((d=o==null?void 0:o.codec)==null?void 0:d.endpoint)||s(e)||""},N=(o,e=F,c=E,r=P)=>{var a,n;const d=s(r)&&s(c),f=(a=o==null?void 0:o.codec)!=null&&a.endpoint?!!((n=o==null?void 0:o.codec)!=null&&n.passAccessToken):!!s(e);return d?!!s(e):f},U=(o,e=L,c=E,r=P)=>{var a,n;const d=s(r)&&s(c),f=(a=o==null?void 0:o.codec)!=null&&a.endpoint?!!((n=o==null?void 0:o.codec)!=null&&n.includeCredentials):!!s(e);return d?!!s(e):f},S=o=>Array.isArray(o)?o:[o];function u(o,e=!0){var r;if(o===null)return o;const c=w(String(((r=o==null?void 0:o.metadata)==null?void 0:r.encoding)??""));if(o!=null&&o.metadata&&(o.metadata.encodingDecoded=c),c!=null&&c.startsWith("json/"))try{const d=z(w(String((o==null?void 0:o.data)??"")));return e?d:{...o,data:d}}catch(d){console.warn("Could not parse payload: ",d)}return c==="binary/null"?e?null:{...o,data:null}:o}const A=(o,e=!0)=>{if(m(o,"searchAttributes")&&m(o.searchAttributes,"indexedFields")){const c=o.searchAttributes.indexedFields;Object.entries(c).forEach(([r,d])=>{c[r]=u(d,e)})}else if(m(o,"searchAttributes")){const c=o.searchAttributes;Object.entries(c).forEach(([r,d])=>{c[r]=u(d,e)})}if(m(o,"memo")&&m(o.memo,"fields")){const c=o.memo.fields;Object.entries(c).forEach(([r,d])=>{c[r]=u(d,e)})}if(m(o,"header")&&m(o.header,"fields")){const c=o.header.fields;Object.entries(c).forEach(([r,d])=>{c[r]=u(d,e)})}if(m(o,"queryResult")){const c=o==null?void 0:o.queryResult;Object.entries(c).forEach(([r,d])=>{c[r]=u(d,e)})}return o},q=(o,e,c)=>async(r,d=!0)=>{var f;if((f=e==null?void 0:e.codec)!=null&&f.endpoint){const a=await J({payloads:{payloads:r},namespace:o,settings:e,accessToken:c});return((a==null?void 0:a.payloads)??[]).map(n=>u(n,d))}else return r.map(a=>u(a,d))},p=(o,...e)=>{for(const c of e)if(o===c)return!0;return!1},I=async(o,e=s(T).params.namespace,c=s(T).data.settings,r=s(H).accessToken)=>{const d=K(c),f=N(c),a=U(c),n={...c,codec:{...c==null?void 0:c.codec,endpoint:d,passAccessToken:f,includeCredentials:a}},t=q(e,n,r);if(o)for(const i of Object.keys(o))if(p(i,"payloads","encodedAttributes")&&o[i]){const l=S(o[i]),C=await t(l);o[i]=p(i,"encodedAttributes")?C[0]:C}else{const l=o[i];R(l)&&(o[i]=await I(l,e,c,r))}return o},X=async(o,e,c,r,d=!0)=>{if(!o)return o;const f=q(e,c,r),a={...o};if(o)for(const n of Object.keys(a))if(p(n,"payloads","encodedAttributes")&&a[n]){const t=S(a[n]),i=await f(t,d);a[n]=p(n,"encodedAttributes")?i[0]:i}else{const t=a[n];R(t)&&(a[n]=await X(t,e,c,r,d))}return a},v=async({attributes:o,namespace:e,settings:c,accessToken:r})=>await I(o,e,c,r);export{N as a,U as b,X as c,A as d,u as e,v as f,K as g,J as h};
