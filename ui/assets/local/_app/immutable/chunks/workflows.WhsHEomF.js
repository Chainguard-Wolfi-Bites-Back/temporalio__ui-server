import{d,r as to,w as x}from"./entry.vrJcZW_o.js";import{p}from"./stores.aYMjbs7c.js";import{t as I}from"./translate.HrioCK44.js";import{f as eo}from"./workflow-counts.Fz9TjqjU.js";import{D as E}from"./scheduler.IHo1m08M.js";import{A as g}from"./workflow-actions.-K4W_iAA.js";import{b as no,c as ro}from"./decode-payload.sfb0Vn0F.js";import{f as so}from"./screaming-enums.NBZzZ07O.js";import{w as io,e as D,s as ao}from"./encode-payload.MPpoSxYI.js";import{s as co}from"./index.8Bs65x02.js";import{a as T}from"./auth-user.njrmBmO7.js";import{i as U,m as L}from"./version-check.HLZIw2tw.js";import{c as j,t as A}from"./versions.ppCz954k.js";import{s as fo}from"./filters.BbPap0N1.js";import{b as lo,p as uo,a as w,r as m,c as wo,d as mo,e as ko}from"./route-for-api.Z6woCQqA.js";import{s as b}from"./parse-with-big-int.e3oI4SEy.js";import{i as yo,c as ho,t as z,d as Eo}from"./format-time.IaB_k5Rs.js";import{a as po}from"./events-service.G9En7aJI.js";import{v as xo}from"./toaster.ACd1of4g.js";const Io=(o=[])=>o.map(t=>{const e=co(t,!0),n=t.activityId;return{...e,id:n}}),go=o=>!o||!o.indexedFields?{}:{indexedFields:Object.entries(o.indexedFields).reduce((e,[n,r])=>({...e,[n]:no(r)}),{})},S=o=>{var R,$,V,q,B,O,N,Q;const t=go(o.workflowExecutionInfo.searchAttributes),e=o.workflowExecutionInfo.memo,n=o.workflowExecutionInfo.type.name,r=o.workflowExecutionInfo.execution.workflowId,s=o.workflowExecutionInfo.execution.runId,a=o.workflowExecutionInfo.startTime,i=o.workflowExecutionInfo.closeTime,c=o.workflowExecutionInfo.executionTime,l=so(o.workflowExecutionInfo.status),u=l==="Running",k=o.workflowExecutionInfo.historyLength,f=o.workflowExecutionInfo.historySizeBytes,y=`/workflows/${r}/${s}`,h=(($=(R=o==null?void 0:o.executionConfig)==null?void 0:R.taskQueue)==null?void 0:$.name)||((V=o==null?void 0:o.workflowExecutionInfo)==null?void 0:V.taskQueue),F=(q=o==null?void 0:o.workflowExecutionInfo)==null?void 0:q.mostRecentWorkerVersionStamp,H=(B=o==null?void 0:o.workflowExecutionInfo)==null?void 0:B.assignedBuildId,J=(O=o==null?void 0:o.workflowExecutionInfo)==null?void 0:O.parentNamespaceId,M=(N=o==null?void 0:o.workflowExecutionInfo)==null?void 0:N.parentExecution,X=o.workflowExecutionInfo.stateTransitionCount,Y=(Q=o.executionConfig)==null?void 0:Q.defaultWorkflowTaskTimeout,Z=Io(o.pendingActivities),oo=(o==null?void 0:o.pendingChildren)??[];return{name:n,id:r,runId:s,startTime:a,endTime:i,executionTime:c,status:l,historyEvents:k,historySizeBytes:f,searchAttributes:t,memo:e,url:y,taskQueue:h,assignedBuildId:H,mostRecentWorkerVersionStamp:F,pendingActivities:Z,pendingChildren:oo,parentNamespaceId:J,parent:M,stateTransitionCount:X,isRunning:u,defaultWorkflowTaskTimeout:Y,get canBeTerminated(){return u&&io()}}},C=o=>(o.executions||[]).map(t=>S({workflowExecutionInfo:t})),bo=(o,t)=>{var e;return((e=o==null?void 0:o.visibilityStore)==null?void 0:e.includes("elasticsearch"))||U(t,"1.19")},Wo=o=>{var t;return(t=o==null?void 0:o.visibilityStore)==null?void 0:t.includes("elasticsearch")},P=d([p],([o])=>{var t,e,n;return(n=(e=(t=o.data)==null?void 0:t.settings)==null?void 0:e.runtimeEnvironment)==null?void 0:n.isCloud}),K=d([j,A,P],([o,t,e])=>bo(o,t)||e);d([j,P],([o,t])=>Wo(o)||t);const To={workflowId:"WorkflowId",workflowType:"WorkflowType",timeRange:"StartTime",executionStatus:"ExecutionStatus",closeTime:"CloseTime"},Ao=["workflowId","workflowType","timeRange","executionStatus","closeTime"],So=o=>!(o===null||o===void 0||o===""||typeof o=="string"&&o==="undefined"),Co=o=>{if(typeof o!="string")return!1;for(const t of Ao)if(t===o)return!0;return!1},Po=(o,t,e)=>{const n=To[o];return t==="All"?"":yo(t)||ho(t)?e||E(K)?`${n} > "${z(t)}"`:`${n} BETWEEN "${z(t)}" AND "${Eo()}"`:`${n}="${t}"`},vo=(o,t)=>Object.entries(o).map(([e,n])=>{if(Co(e)&&So(n))return Po(e,n,t)}).filter(Boolean),Fo=(o,t=!1)=>vo(o,t).join(" and ");function Ro(o){console.error("Unhandled action:",o)}const $o=(o,t)=>{let e;switch(o){case g.Cancel:e=I("workflows.canceled");break;case g.Reset:e=I("workflows.reset");break;case g.Terminate:e=I("workflows.terminated");break;default:Ro(o)}return t?I("workflows.workflow-action-reason-placeholder-with-email",{action:e,email:t}):I("workflows.workflow-action-reason-placeholder",{action:e})},_=({action:o,reason:t,email:e})=>{const n=$o(o,e);return t?[t.trim(),n].join(" "):n},v=async(o,t,e=fetch,n=!1)=>{const r=t.query||Fo(t,n);let s;try{s=decodeURIComponent(r)}catch{s=r}const a=n?"workflows.archived":"workflows";let i="";const c=f=>{var y,h;wo(f),(y=f==null?void 0:f.body)!=null&&y.message||f!=null&&f.status?i=((h=f==null?void 0:f.body)==null?void 0:h.message)??`Error fetching workflows: ${f.status}: ${f.statusText}`:i="Error fetching workflows: Server failed to respond"},l=m(a,{namespace:o}),{executions:u,nextPageToken:k}=await w(l,{params:{query:s},onError:c,handleError:c,request:e})??{executions:[],nextPageToken:""};return{workflows:C({executions:u}),nextPageToken:String(k),error:i}},mt=async({namespace:o,workflowId:t,url:e},n=fetch)=>{var u;const r="workflows",s=e??lo(o),a=uo(r,{namespace:o}),i=s+a,{executions:c}=await w(i,{params:{query:`WorkflowId="${t}"`,pageSize:"1"},request:n})??{executions:[]},l=(u=C({executions:c}))==null?void 0:u[0];return{runId:l==null?void 0:l.runId}},kt=async(o,t=fetch,e=!1)=>{const n=e?"workflows.archived":"workflows";let r=!0;const s=i=>{(mo(i)||ko(i))&&(r=!1)},a=m(n,{namespace:o});return await w(a,{params:{pageSize:"1"},onError:s,handleError:s,request:t}),{authorized:r}},yt=async(o,t,e=fetch)=>v(o,t,e,!0);async function ht(o,t=fetch){const e=m("workflow",{namespace:o.namespace,workflowId:o.workflowId});return w(e,{request:t,notifyOnError:!1,params:{"execution.runId":o.runId}}).then(n=>({workflow:S(n)})).catch(n=>({error:n}))}async function Et({workflow:o,namespace:t,reason:e}){const n=m("workflow.terminate",{namespace:t,workflowId:o.id}),r=E(T).email,s=_({reason:e,action:g.Terminate,email:r});return await w(n,{options:{method:"POST",body:b({reason:s,...r&&{identity:r}})},notifyOnError:!1,params:{"execution.runId":o.runId}})}async function pt({namespace:o,workflow:{id:t,runId:e}},n=fetch){const r=m("workflow.cancel",{namespace:o,workflowId:t});return w(r,{request:n,notifyOnError:!1,options:{method:"POST"},params:{"execution.runId":e}})}async function xt({namespace:o,workflow:{id:t,runId:e},name:n,input:r}){const s=m("workflow.signal",{namespace:o,workflowId:t,signalName:n}),a=await D(r),i=E(p).data.settings,c=(i==null?void 0:i.version)??"",u=U(c,"2.22")?{signalName:n,workflowExecution:{workflowId:t,runId:e},input:{payloads:a}}:{signalName:n,input:{payloads:a},params:{"execution.runId":e}};return w(s,{notifyOnError:!1,options:{method:"POST",body:b(u)}})}async function It({namespace:o,workflow:{id:t,runId:e},eventId:n,reason:r,reapplyType:s}){const a=m("workflow.reset",{namespace:o,workflowId:t}),i=E(T).email,c=_({action:g.Reset,reason:r,email:i}),l={workflowExecution:{workflowId:t,runId:e},workflowTaskFinishEventId:n,resetReapplyType:s,requestId:xo(),reason:c};return w(a,{notifyOnError:!1,options:{method:"POST",body:b(l)},params:{"execution.runId":e}})}async function gt(o,t=fetch){const e=r=>{console.error(r)},n=m("workflow",o);return w(n,{request:t,onError:e,handleError:e}).then(S)}async function bt(o,t,e){if(!E(G))return[];try{let n=`ParentWorkflowId = "${t}"`;e&&(n+=` AND ParentRunId = "${e}"`);const{workflows:r}=await v(o,{query:n});return r}catch{return[]}}const Vo=o=>{if(!o.length)return{};const t={};return o.forEach(e=>{t[e.attribute]=ao(e.value)}),t};async function Wt({namespace:o,workflowId:t,taskQueue:e,workflowType:n,input:r,searchAttributes:s}){const a=m("workflow",{namespace:o,workflowId:t});let i;if(r)try{i=await D(r)}catch{console.error("Could not decode input for starting workflow")}const c=b({workflowId:t,taskQueue:{name:e},workflowType:{name:n},input:i?{payloads:i}:null,searchAttributes:s.length===0?null:{indexedFields:{...Vo(s)}}});return w(a,{notifyOnError:!1,options:{method:"POST",body:c}})}const Tt=async({namespace:o,workflowType:t,workflowId:e})=>{var s,a,i;const n=c=>{console.error(c)},r={input:"",searchAttributes:void 0};try{let c="";t&&e?c=`WorkflowType = "${t}" AND WorkflowId = "${e}"`:t?c=`WorkflowType = "${t}"`:e&&(c=`WorkflowId = "${e}"`);const l=m("workflows",{namespace:o}),u=await w(l,{params:{query:c,pageSize:"1"},handleError:n});if(!((s=u==null?void 0:u.executions)!=null&&s[0]))return r;const k=C(u)[0],y=await po({namespace:o,workflowId:k.id,runId:k.runId}),h=await ro((a=y==null?void 0:y.attributes)==null?void 0:a.input,o,E(p).data.settings,E(T).accessToken);return{input:b(h==null?void 0:h.payloads[0]),searchAttributes:(i=k==null?void 0:k.searchAttributes)==null?void 0:i.indexedFields}}catch{return r}},qo=300,Bo=async(o,t,e)=>{t.set(!0);try{await e()}catch(n){console.error(n)}o.set(!1),setTimeout(()=>{t.set(!1)},qo)},Oo=d([p],([o])=>{var t,e,n;return!!((n=(e=(t=o.data)==null?void 0:t.systemInfo)==null?void 0:e.capabilities)!=null&&n.countGroupByExecutionStatus)}),At=d([p,A],([o,t])=>{var r,s,a;const e=L("1.23.0",t),n=!!((a=(s=(r=o.data)==null?void 0:r.systemInfo)==null?void 0:s.capabilities)!=null&&a.prefixSearch);return e||n}),No=x(0),Qo=d([p],([o])=>{var t,e;return(e=(t=o.data)==null?void 0:t.settings)==null?void 0:e.hideWorkflowQueryErrors}),G=d([P,A],([o,t])=>o||L("1.23.0",t)),zo=d([p],([o])=>o.url.searchParams.get("query")),Do=d([zo,G,fo],([o,t,e])=>t&&!e?o?`ParentWorkflowId is NULL AND ${o}`:"ParentWorkflowId is NULL":o),Uo=d([p],([o])=>o.params.namespace),Lo=d([Uo,Do,No,K,Qo],([o,t,e,n,r])=>({namespace:o,query:t,refresh:e,supportsAdvancedVisibility:n,hideWorkflowQueryErrors:r})),jo=o=>{Ho.set({...o,newCount:0})},Ko=o=>Lo.subscribe(({namespace:t,query:e,supportsAdvancedVisibility:n,hideWorkflowQueryErrors:r})=>{Bo(Go,_o,async()=>{const{workflows:s,error:a}=await v(t,{query:e});if(o(s),n&&!E(Oo)){const i=await eo(t,e);jo(i)}a?r?W.set(I("workflows.workflows-error-querying")):W.set(a):W.set("")})}),St=x(""),_o=x(!0),Go=x(!0),Ho=x({count:0,newCount:0}),W=x(""),Ct=to([],Ko),Pt=x("");export{Tt as A,Wt as B,kt as a,bt as b,pt as c,yt as d,Fo as e,mt as f,St as g,It as h,ht as i,gt as j,Oo as k,Pt as l,$o as m,P as n,K as o,At as p,Do as q,No as r,xt as s,Et as t,G as u,Ct as v,Ho as w,Go as x,_o as y,W as z};
