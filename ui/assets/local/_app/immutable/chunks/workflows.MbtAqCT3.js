import{d as u,r as to,w as k}from"./entry.fNUcCW-j.js";import{p as y}from"./stores.HX3WVoC8.js";import{t as h}from"./translate.HrioCK44.js";import{v as q,D as E}from"./scheduler.CFZRjJlR.js";import{r as d,a as l,b as no,p as ro,c as eo,d as so,e as io}from"./route-for-api.QrnDw3jv.js";import{A as x}from"./workflow-actions.-K4W_iAA.js";import{h as ao}from"./decode-payload.Jq6ofh-K.js";import{f as co}from"./screaming-enums.NBZzZ07O.js";import{w as fo}from"./write-actions-are-allowed.1UDnpi7F.js";import{s as uo}from"./simplify-attributes.5mrXQavX.js";import{a as Q}from"./auth-user.9JiL9NAd.js";import{i as z,m as U}from"./version-check.HLZIw2tw.js";import{c as D,t as W}from"./versions.vgzD1N_b.js";import{s as lo}from"./filters.u-6cnCTp.js";import{e as wo}from"./encode-payload.Mn4u_TiP.js";import{s as T}from"./parse-with-big-int.e3oI4SEy.js";import{i as mo,d as ko,e as N,h as yo}from"./format-time.6T8OwT4v.js";import{v as ho}from"./toaster.xYKOkkmR.js";const Eo=async(o,t,n=fetch)=>{let r=0;try{const e=d("workflows.count",{namespace:o}),s=await l(e,{params:t?{query:t}:{},onError:q,handleError:q,request:n});r=parseInt((s==null?void 0:s.count)||"0")}catch{}return{count:r}},ut=async({namespace:o,query:t})=>{const n="GROUP BY ExecutionStatus",r=d("workflows.count",{namespace:o}),{count:e,groups:s}=await l(r,{params:{query:t?`${t} ${n}`:`${n}`},notifyOnError:!1});return{count:e??"0",groups:s}},xo=(o=[])=>o.map(t=>{const n=uo(t,!0),r=t.activityId;return{...n,id:r}}),po=o=>!o||!o.indexedFields?{}:{indexedFields:Object.entries(o.indexedFields).reduce((n,[r,e])=>({...n,[r]:ao(e)}),{})},A=o=>{var P,R,v,B,$,O,F,V;const t=po(o.workflowExecutionInfo.searchAttributes),n=o.workflowExecutionInfo.memo,r=o.workflowExecutionInfo.type.name,e=o.workflowExecutionInfo.execution.workflowId,s=o.workflowExecutionInfo.execution.runId,i=o.workflowExecutionInfo.startTime,a=o.workflowExecutionInfo.closeTime,w=o.workflowExecutionInfo.executionTime,f=co(o.workflowExecutionInfo.status),m=f==="Running",g=o.workflowExecutionInfo.historyLength,c=o.workflowExecutionInfo.historySizeBytes,p=`/workflows/${e}/${s}`,I=((R=(P=o==null?void 0:o.executionConfig)==null?void 0:P.taskQueue)==null?void 0:R.name)||((v=o==null?void 0:o.workflowExecutionInfo)==null?void 0:v.taskQueue),_=(B=o==null?void 0:o.workflowExecutionInfo)==null?void 0:B.mostRecentWorkerVersionStamp,Y=($=o==null?void 0:o.workflowExecutionInfo)==null?void 0:$.assignedBuildId,H=(O=o==null?void 0:o.workflowExecutionInfo)==null?void 0:O.parentNamespaceId,J=(F=o==null?void 0:o.workflowExecutionInfo)==null?void 0:F.parentExecution,M=o.workflowExecutionInfo.stateTransitionCount,X=(V=o.executionConfig)==null?void 0:V.defaultWorkflowTaskTimeout,Z=xo(o.pendingActivities),oo=(o==null?void 0:o.pendingChildren)??[];return{name:r,id:e,runId:s,startTime:i,endTime:a,executionTime:w,status:f,historyEvents:g,historySizeBytes:c,searchAttributes:t,memo:n,url:p,taskQueue:I,assignedBuildId:Y,mostRecentWorkerVersionStamp:_,pendingActivities:Z,pendingChildren:oo,parentNamespaceId:H,parent:J,stateTransitionCount:M,isRunning:m,defaultWorkflowTaskTimeout:X,get canBeTerminated(){return m&&fo()}}},L=o=>(o.executions||[]).map(t=>A({workflowExecutionInfo:t})),Io=(o,t)=>{var n;return((n=o==null?void 0:o.visibilityStore)==null?void 0:n.includes("elasticsearch"))||z(t,"1.19")},go=o=>{var t;return(t=o==null?void 0:o.visibilityStore)==null?void 0:t.includes("elasticsearch")},S=u([y],([o])=>{var t,n,r;return(r=(n=(t=o.data)==null?void 0:t.settings)==null?void 0:n.runtimeEnvironment)==null?void 0:r.isCloud}),j=u([D,W,S],([o,t,n])=>Io(o,t)||n);u([D,S],([o,t])=>go(o)||t);const bo={workflowId:"WorkflowId",workflowType:"WorkflowType",timeRange:"StartTime",executionStatus:"ExecutionStatus",closeTime:"CloseTime"},Wo=["workflowId","workflowType","timeRange","executionStatus","closeTime"],To=o=>!(o===null||o===void 0||o===""||typeof o=="string"&&o==="undefined"),Ao=o=>{if(typeof o!="string")return!1;for(const t of Wo)if(t===o)return!0;return!1},So=(o,t,n)=>{const r=bo[o];return t==="All"?"":mo(t)||ko(t)?n||E(j)?`${r} > "${N(t)}"`:`${r} BETWEEN "${N(t)}" AND "${yo()}"`:`${r}="${t}"`},Co=(o,t)=>Object.entries(o).map(([n,r])=>{if(Ao(n)&&To(r))return So(n,r,t)}).filter(Boolean),Po=(o,t=!1)=>Co(o,t).join(" and ");function Ro(o){console.error("Unhandled action:",o)}const vo=(o,t)=>{let n;switch(o){case x.Cancel:n=h("workflows.canceled");break;case x.Reset:n=h("workflows.reset");break;case x.Terminate:n=h("workflows.terminated");break;default:Ro(o)}return t?h("workflows.workflow-action-reason-placeholder-with-email",{action:n,email:t}):h("workflows.workflow-action-reason-placeholder",{action:n})},K=({action:o,reason:t,email:n})=>{const r=vo(o,n);return t?[t.trim(),r].join(" "):r},C=async(o,t,n=fetch,r=!1)=>{const e=t.query||Po(t,r);let s;try{s=decodeURIComponent(e)}catch{s=e}const i=r?"workflows.archived":"workflows";let a="";const w=c=>{var p,I;eo(c),(p=c==null?void 0:c.body)!=null&&p.message||c!=null&&c.status?a=((I=c==null?void 0:c.body)==null?void 0:I.message)??`Error fetching workflows: ${c.status}: ${c.statusText}`:a="Error fetching workflows: Server failed to respond"},f=d(i,{namespace:o}),{executions:m,nextPageToken:g}=await l(f,{params:{query:s},onError:w,handleError:w,request:n})??{executions:[],nextPageToken:""};return{workflows:L({executions:m}),nextPageToken:String(g),error:a}},lt=async({namespace:o,workflowId:t,url:n},r=fetch)=>{var m;const e="workflows",s=n??no(o),i=ro(e,{namespace:o}),a=s+i,{executions:w}=await l(a,{params:{query:`WorkflowId="${t}"`,pageSize:"1"},request:r})??{executions:[]},f=(m=L({executions:w}))==null?void 0:m[0];return{runId:f==null?void 0:f.runId}},wt=async(o,t=fetch,n=!1)=>{const r=n?"workflows.archived":"workflows";let e=!0;const s=a=>{(so(a)||io(a))&&(e=!1)},i=d(r,{namespace:o});return await l(i,{params:{pageSize:"1"},onError:s,handleError:s,request:t}),{authorized:e}},dt=async(o,t,n=fetch)=>C(o,t,n,!0);async function mt(o,t=fetch){const n=d("workflow",{namespace:o.namespace,workflowId:o.workflowId});return l(n,{request:t,notifyOnError:!1,params:{"execution.runId":o.runId}}).then(r=>({workflow:A(r)})).catch(r=>({error:r}))}async function kt({workflow:o,namespace:t,reason:n}){const r=d("workflow.terminate",{namespace:t,workflowId:o.id}),e=E(Q).email,s=K({reason:n,action:x.Terminate,email:e});return await l(r,{options:{method:"POST",body:T({reason:s,...e&&{identity:e}})},notifyOnError:!1,params:{"execution.runId":o.runId}})}async function yt({namespace:o,workflow:{id:t,runId:n}},r=fetch){const e=d("workflow.cancel",{namespace:o,workflowId:t});return l(e,{request:r,notifyOnError:!1,options:{method:"POST"},params:{"execution.runId":n}})}async function ht({namespace:o,workflow:{id:t,runId:n},name:r,input:e}){const s=d("workflow.signal",{namespace:o,workflowId:t,signalName:r}),i=await wo(e),a=E(y).data.settings,w=(a==null?void 0:a.version)??"",m=z(w,"2.22")?{signalName:r,workflowExecution:{workflowId:t,runId:n},input:{payloads:i}}:{signalName:r,input:{payloads:i},params:{"execution.runId":n}};return l(s,{notifyOnError:!1,options:{method:"POST",body:T(m)}})}async function Et({namespace:o,workflow:{id:t,runId:n},eventId:r,reason:e,reapplyType:s}){const i=d("workflow.reset",{namespace:o,workflowId:t}),a=E(Q).email,w=K({action:x.Reset,reason:e,email:a}),f={workflowExecution:{workflowId:t,runId:n},workflowTaskFinishEventId:r,resetReapplyType:s,requestId:ho(),reason:w};return l(i,{notifyOnError:!1,options:{method:"POST",body:T(f)},params:{"execution.runId":n}})}async function xt(o,t=fetch){const n=e=>{console.error(e)},r=d("workflow",o);return l(r,{request:t,onError:n,handleError:n}).then(A)}async function pt(o,t,n){if(!E(G))return[];try{let r=`ParentWorkflowId = "${t}"`;n&&(r+=` AND ParentRunId = "${n}"`);const{workflows:e}=await C(o,{query:r});return e}catch{return[]}}const Bo=300,$o=async(o,t,n)=>{t.set(!0);try{await n()}catch(r){console.error(r)}o.set(!1),setTimeout(()=>{t.set(!1)},Bo)},Oo=u([y],([o])=>{var t,n,r;return!!((r=(n=(t=o.data)==null?void 0:t.systemInfo)==null?void 0:n.capabilities)!=null&&r.countGroupByExecutionStatus)}),It=u([y,W],([o,t])=>{var e,s,i;const n=U("1.23.0",t),r=!!((i=(s=(e=o.data)==null?void 0:e.systemInfo)==null?void 0:s.capabilities)!=null&&i.prefixSearch);return n||r}),Fo=k(0),Vo=u([y],([o])=>{var t,n;return(n=(t=o.data)==null?void 0:t.settings)==null?void 0:n.hideWorkflowQueryErrors}),G=u([S,W],([o,t])=>o||U("1.23.0",t)),qo=u([y],([o])=>o.url.searchParams.get("query")),No=u([qo,G,lo],([o,t,n])=>t&&!n?o?`ParentWorkflowId is NULL AND ${o}`:"ParentWorkflowId is NULL":o),Qo=u([y],([o])=>o.params.namespace),zo=u([Qo,No,Fo,j,Vo],([o,t,n,r,e])=>({namespace:o,query:t,refresh:n,supportsAdvancedVisibility:r,hideWorkflowQueryErrors:e})),Uo=o=>{Ko.set({...o,newCount:0})},Do=o=>zo.subscribe(({namespace:t,query:n,supportsAdvancedVisibility:r,hideWorkflowQueryErrors:e})=>{$o(jo,Lo,async()=>{const{workflows:s,error:i}=await C(t,{query:n});if(o(s),r&&!E(Oo)){const a=await Eo(t,n);Uo(a)}i?e?b.set(h("workflows.workflows-error-querying")):b.set(i):b.set("")})}),gt=k(""),Lo=k(!0),jo=k(!0),Ko=k({count:0,newCount:0}),b=k(""),bt=to([],Do),Wt=k("");export{b as A,wt as a,pt as b,yt as c,ut as d,dt as e,lt as f,Po as g,gt as h,Et as i,mt as j,xt as k,Oo as l,Wt as m,vo as n,S as o,j as p,No as q,Fo as r,ht as s,kt as t,It as u,G as v,Ko as w,bt as x,jo as y,Lo as z};
