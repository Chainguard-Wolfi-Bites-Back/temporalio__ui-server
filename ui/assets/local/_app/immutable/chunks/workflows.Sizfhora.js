import{d as l,r as oo,w as k}from"./entry.KOL5lxel.js";import{p as y}from"./stores.NtU019gU.js";import{t as h}from"./translate.HrioCK44.js";import{f as to}from"./workflow-counts.vIAYae_J.js";import{D as E}from"./scheduler.CFZRjJlR.js";import{A as x}from"./workflow-actions.-K4W_iAA.js";import{b as ro}from"./decode-payload.siSOoPSe.js";import{f as no}from"./screaming-enums.NBZzZ07O.js";import{w as eo,e as io}from"./encode-payload.npZ1QL1p.js";import{s as so}from"./simplify-attributes.XwuQ_nmt.js";import{a as N}from"./auth-user.jVbvsIU9.js";import{i as Q,m as z}from"./version-check.HLZIw2tw.js";import{c as U,t as W}from"./versions.lmaOGQO4.js";import{s as ao}from"./filters.T9vQkS20.js";import{b as co,p as fo,a as d,r as m,c as lo,d as uo,e as wo}from"./route-for-api.mPVmpl5q.js";import{s as T}from"./parse-with-big-int.e3oI4SEy.js";import{i as mo,c as ko,t as $,d as yo}from"./format-time.jDXcfIws.js";import{v as ho}from"./toaster.g9f6GlmJ.js";const Eo=(o=[])=>o.map(t=>{const r=so(t,!0),n=t.activityId;return{...r,id:n}}),xo=o=>!o||!o.indexedFields?{}:{indexedFields:Object.entries(o.indexedFields).reduce((r,[n,e])=>({...r,[n]:ro(e)}),{})},A=o=>{var P,R,v,q,F,V,B,O;const t=xo(o.workflowExecutionInfo.searchAttributes),r=o.workflowExecutionInfo.memo,n=o.workflowExecutionInfo.type.name,e=o.workflowExecutionInfo.execution.workflowId,i=o.workflowExecutionInfo.execution.runId,s=o.workflowExecutionInfo.startTime,a=o.workflowExecutionInfo.closeTime,u=o.workflowExecutionInfo.executionTime,f=no(o.workflowExecutionInfo.status),w=f==="Running",p=o.workflowExecutionInfo.historyLength,c=o.workflowExecutionInfo.historySizeBytes,I=`/workflows/${e}/${i}`,g=((R=(P=o==null?void 0:o.executionConfig)==null?void 0:P.taskQueue)==null?void 0:R.name)||((v=o==null?void 0:o.workflowExecutionInfo)==null?void 0:v.taskQueue),_=(q=o==null?void 0:o.workflowExecutionInfo)==null?void 0:q.mostRecentWorkerVersionStamp,G=(F=o==null?void 0:o.workflowExecutionInfo)==null?void 0:F.assignedBuildId,H=(V=o==null?void 0:o.workflowExecutionInfo)==null?void 0:V.parentNamespaceId,J=(B=o==null?void 0:o.workflowExecutionInfo)==null?void 0:B.parentExecution,M=o.workflowExecutionInfo.stateTransitionCount,X=(O=o.executionConfig)==null?void 0:O.defaultWorkflowTaskTimeout,Y=Eo(o.pendingActivities),Z=(o==null?void 0:o.pendingChildren)??[];return{name:n,id:e,runId:i,startTime:s,endTime:a,executionTime:u,status:f,historyEvents:p,historySizeBytes:c,searchAttributes:t,memo:r,url:I,taskQueue:g,assignedBuildId:G,mostRecentWorkerVersionStamp:_,pendingActivities:Y,pendingChildren:Z,parentNamespaceId:H,parent:J,stateTransitionCount:M,isRunning:w,defaultWorkflowTaskTimeout:X,get canBeTerminated(){return w&&eo()}}},D=o=>(o.executions||[]).map(t=>A({workflowExecutionInfo:t})),Io=(o,t)=>{var r;return((r=o==null?void 0:o.visibilityStore)==null?void 0:r.includes("elasticsearch"))||Q(t,"1.19")},go=o=>{var t;return(t=o==null?void 0:o.visibilityStore)==null?void 0:t.includes("elasticsearch")},S=l([y],([o])=>{var t,r,n;return(n=(r=(t=o.data)==null?void 0:t.settings)==null?void 0:r.runtimeEnvironment)==null?void 0:n.isCloud}),L=l([U,W,S],([o,t,r])=>Io(o,t)||r);l([U,S],([o,t])=>go(o)||t);const po={workflowId:"WorkflowId",workflowType:"WorkflowType",timeRange:"StartTime",executionStatus:"ExecutionStatus",closeTime:"CloseTime"},bo=["workflowId","workflowType","timeRange","executionStatus","closeTime"],Wo=o=>!(o===null||o===void 0||o===""||typeof o=="string"&&o==="undefined"),To=o=>{if(typeof o!="string")return!1;for(const t of bo)if(t===o)return!0;return!1},Ao=(o,t,r)=>{const n=po[o];return t==="All"?"":mo(t)||ko(t)?r||E(L)?`${n} > "${$(t)}"`:`${n} BETWEEN "${$(t)}" AND "${yo()}"`:`${n}="${t}"`},So=(o,t)=>Object.entries(o).map(([r,n])=>{if(To(r)&&Wo(n))return Ao(r,n,t)}).filter(Boolean),Co=(o,t=!1)=>So(o,t).join(" and ");function Po(o){console.error("Unhandled action:",o)}const Ro=(o,t)=>{let r;switch(o){case x.Cancel:r=h("workflows.canceled");break;case x.Reset:r=h("workflows.reset");break;case x.Terminate:r=h("workflows.terminated");break;default:Po(o)}return t?h("workflows.workflow-action-reason-placeholder-with-email",{action:r,email:t}):h("workflows.workflow-action-reason-placeholder",{action:r})},j=({action:o,reason:t,email:r})=>{const n=Ro(o,r);return t?[t.trim(),n].join(" "):n},C=async(o,t,r=fetch,n=!1)=>{const e=t.query||Co(t,n);let i;try{i=decodeURIComponent(e)}catch{i=e}const s=n?"workflows.archived":"workflows";let a="";const u=c=>{var I,g;lo(c),(I=c==null?void 0:c.body)!=null&&I.message||c!=null&&c.status?a=((g=c==null?void 0:c.body)==null?void 0:g.message)??`Error fetching workflows: ${c.status}: ${c.statusText}`:a="Error fetching workflows: Server failed to respond"},f=m(s,{namespace:o}),{executions:w,nextPageToken:p}=await d(f,{params:{query:i},onError:u,handleError:u,request:r})??{executions:[],nextPageToken:""};return{workflows:D({executions:w}),nextPageToken:String(p),error:a}},ft=async({namespace:o,workflowId:t,url:r},n=fetch)=>{var w;const e="workflows",i=r??co(o),s=fo(e,{namespace:o}),a=i+s,{executions:u}=await d(a,{params:{query:`WorkflowId="${t}"`,pageSize:"1"},request:n})??{executions:[]},f=(w=D({executions:u}))==null?void 0:w[0];return{runId:f==null?void 0:f.runId}},lt=async(o,t=fetch,r=!1)=>{const n=r?"workflows.archived":"workflows";let e=!0;const i=a=>{(uo(a)||wo(a))&&(e=!1)},s=m(n,{namespace:o});return await d(s,{params:{pageSize:"1"},onError:i,handleError:i,request:t}),{authorized:e}},ut=async(o,t,r=fetch)=>C(o,t,r,!0);async function wt(o,t=fetch){const r=m("workflow",{namespace:o.namespace,workflowId:o.workflowId});return d(r,{request:t,notifyOnError:!1,params:{"execution.runId":o.runId}}).then(n=>({workflow:A(n)})).catch(n=>({error:n}))}async function dt({workflow:o,namespace:t,reason:r}){const n=m("workflow.terminate",{namespace:t,workflowId:o.id}),e=E(N).email,i=j({reason:r,action:x.Terminate,email:e});return await d(n,{options:{method:"POST",body:T({reason:i,...e&&{identity:e}})},notifyOnError:!1,params:{"execution.runId":o.runId}})}async function mt({namespace:o,workflow:{id:t,runId:r}},n=fetch){const e=m("workflow.cancel",{namespace:o,workflowId:t});return d(e,{request:n,notifyOnError:!1,options:{method:"POST"},params:{"execution.runId":r}})}async function kt({namespace:o,workflow:{id:t,runId:r},name:n,input:e}){const i=m("workflow.signal",{namespace:o,workflowId:t,signalName:n}),s=await io(e),a=E(y).data.settings,u=(a==null?void 0:a.version)??"",w=Q(u,"2.22")?{signalName:n,workflowExecution:{workflowId:t,runId:r},input:{payloads:s}}:{signalName:n,input:{payloads:s},params:{"execution.runId":r}};return d(i,{notifyOnError:!1,options:{method:"POST",body:T(w)}})}async function yt({namespace:o,workflow:{id:t,runId:r},eventId:n,reason:e,reapplyType:i}){const s=m("workflow.reset",{namespace:o,workflowId:t}),a=E(N).email,u=j({action:x.Reset,reason:e,email:a}),f={workflowExecution:{workflowId:t,runId:r},workflowTaskFinishEventId:n,resetReapplyType:i,requestId:ho(),reason:u};return d(s,{notifyOnError:!1,options:{method:"POST",body:T(f)},params:{"execution.runId":r}})}async function ht(o,t=fetch){const r=e=>{console.error(e)},n=m("workflow",o);return d(n,{request:t,onError:r,handleError:r}).then(A)}async function Et(o,t,r){if(!E(K))return[];try{let n=`ParentWorkflowId = "${t}"`;r&&(n+=` AND ParentRunId = "${r}"`);const{workflows:e}=await C(o,{query:n});return e}catch{return[]}}const vo=300,qo=async(o,t,r)=>{t.set(!0);try{await r()}catch(n){console.error(n)}o.set(!1),setTimeout(()=>{t.set(!1)},vo)},Fo=l([y],([o])=>{var t,r,n;return!!((n=(r=(t=o.data)==null?void 0:t.systemInfo)==null?void 0:r.capabilities)!=null&&n.countGroupByExecutionStatus)}),xt=l([y,W],([o,t])=>{var e,i,s;const r=z("1.23.0",t),n=!!((s=(i=(e=o.data)==null?void 0:e.systemInfo)==null?void 0:i.capabilities)!=null&&s.prefixSearch);return r||n}),Vo=k(0),Bo=l([y],([o])=>{var t,r;return(r=(t=o.data)==null?void 0:t.settings)==null?void 0:r.hideWorkflowQueryErrors}),K=l([S,W],([o,t])=>o||z("1.23.0",t)),Oo=l([y],([o])=>o.url.searchParams.get("query")),$o=l([Oo,K,ao],([o,t,r])=>t&&!r?o?`ParentWorkflowId is NULL AND ${o}`:"ParentWorkflowId is NULL":o),No=l([y],([o])=>o.params.namespace),Qo=l([No,$o,Vo,L,Bo],([o,t,r,n,e])=>({namespace:o,query:t,refresh:r,supportsAdvancedVisibility:n,hideWorkflowQueryErrors:e})),zo=o=>{jo.set({...o,newCount:0})},Uo=o=>Qo.subscribe(({namespace:t,query:r,supportsAdvancedVisibility:n,hideWorkflowQueryErrors:e})=>{qo(Lo,Do,async()=>{const{workflows:i,error:s}=await C(t,{query:r});if(o(i),n&&!E(Fo)){const a=await to(t,r);zo(a)}s?e?b.set(h("workflows.workflows-error-querying")):b.set(s):b.set("")})}),It=k(""),Do=k(!0),Lo=k(!0),jo=k({count:0,newCount:0}),b=k(""),gt=oo([],Uo),pt=k("");export{lt as a,Et as b,mt as c,ut as d,Co as e,ft as f,It as g,yt as h,wt as i,ht as j,Fo as k,pt as l,Ro as m,S as n,L as o,xt as p,$o as q,Vo as r,kt as s,dt as t,K as u,gt as v,jo as w,Lo as x,Do as y,b as z};
