import{z as x}from"./scheduler.fjKs9yxd.js";import{p as P}from"./stores.xXGfB8XE.js";import{A as k}from"./workflow-actions.-K4W_iAA.js";import{h as L}from"./decode-payload.xuc6wLVi.js";import{f as _}from"./screaming-enums.NBZzZ07O.js";import{w as G}from"./write-actions-are-allowed.xZ4zwrfz.js";import{s as H}from"./simplify-attributes.gznepjUm.js";import{a as $}from"./auth-user.cOPTTsKc.js";import{e as J}from"./encode-payload.IfwDCvgY.js";import{b as M,p as X,a as d,r as w,c as Y,d as Z,e as oo}from"./route-for-api.7XfFAgPa.js";import{s as I}from"./parse-with-big-int.e3oI4SEy.js";import{d as g}from"./entry.k_eLziLW.js";import{i as v}from"./version-check.lUTm-NBD.js";import{c as C,t as to}from"./versions.4slFdX36.js";import{i as no,b as eo,t as O,c as ro}from"./format-time.9mIRALNp.js";import{t as m}from"./translate.Itygs_Qz.js";import{v as io}from"./toaster.16-OegwU.js";const ao=(o=[])=>o.map(t=>{const n=H(t,!0),e=t.activityId;return{...n,id:e}}),so=o=>!o||!o.indexedFields?{}:{indexedFields:Object.entries(o.indexedFields).reduce((n,[e,r])=>({...n,[e]:L(r)}),{})},T=o=>{var p,b,W,A,S,R,F;const t=so(o.workflowExecutionInfo.searchAttributes),n=o.workflowExecutionInfo.memo,e=o.workflowExecutionInfo.type.name,r=o.workflowExecutionInfo.execution.workflowId,i=o.workflowExecutionInfo.execution.runId,c=o.workflowExecutionInfo.startTime,a=o.workflowExecutionInfo.closeTime,l=o.workflowExecutionInfo.executionTime,f=_(o.workflowExecutionInfo.status),u=f==="Running",E=o.workflowExecutionInfo.historyLength,s=o.workflowExecutionInfo.historySizeBytes,y=`/workflows/${r}/${i}`,h=((b=(p=o==null?void 0:o.executionConfig)==null?void 0:p.taskQueue)==null?void 0:b.name)||((W=o==null?void 0:o.workflowExecutionInfo)==null?void 0:W.taskQueue),q=(A=o==null?void 0:o.workflowExecutionInfo)==null?void 0:A.mostRecentWorkerVersionStamp,B=(S=o==null?void 0:o.workflowExecutionInfo)==null?void 0:S.parentNamespaceId,Q=(R=o==null?void 0:o.workflowExecutionInfo)==null?void 0:R.parentExecution,U=o.workflowExecutionInfo.stateTransitionCount,j=(F=o.executionConfig)==null?void 0:F.defaultWorkflowTaskTimeout,K=ao(o.pendingActivities),D=(o==null?void 0:o.pendingChildren)??[];return{name:e,id:r,runId:i,startTime:c,endTime:a,executionTime:l,status:f,historyEvents:E,historySizeBytes:s,searchAttributes:t,memo:n,url:y,taskQueue:h,mostRecentWorkerVersionStamp:q,pendingActivities:K,pendingChildren:D,parentNamespaceId:B,parent:Q,stateTransitionCount:U,isRunning:u,defaultWorkflowTaskTimeout:j,get canBeTerminated(){return u&&G()}}},V=o=>(o.executions||[]).map(t=>T({workflowExecutionInfo:t})),co=(o,t)=>{var n;return((n=o==null?void 0:o.visibilityStore)==null?void 0:n.includes("elasticsearch"))||v(t,"1.19")},fo=o=>{var t;return(t=o==null?void 0:o.visibilityStore)==null?void 0:t.includes("elasticsearch")},z=g([P],([o])=>{var t,n,e;return(e=(n=(t=o.data)==null?void 0:t.settings)==null?void 0:n.runtimeEnvironment)==null?void 0:e.isCloud}),lo=g([C,to,z],([o,t,n])=>co(o,t)||n);g([C,z],([o,t])=>fo(o)||t);const uo={workflowId:"WorkflowId",workflowType:"WorkflowType",timeRange:"StartTime",executionStatus:"ExecutionStatus",closeTime:"CloseTime"},wo=["workflowId","workflowType","timeRange","executionStatus","closeTime"],mo=o=>!(o===null||o===void 0||o===""||typeof o=="string"&&o==="undefined"),ko=o=>{if(typeof o!="string")return!1;for(const t of wo)if(t===o)return!0;return!1},yo=(o,t,n)=>{const e=uo[o];return t==="All"?"":no(t)||eo(t)?n||x(lo)?`${e} > "${O(t)}"`:`${e} BETWEEN "${O(t)}" AND "${ro()}"`:`${e}="${t}"`},ho=(o,t)=>Object.entries(o).map(([n,e])=>{if(ko(n)&&mo(e))return yo(n,e,t)}).filter(Boolean),xo=(o,t=!1)=>ho(o,t).join(" and ");function Eo(o){console.error("Unhandled action:",o)}const Io=(o,t)=>{let n;switch(o){case k.Cancel:n=m("workflows.canceled");break;case k.Reset:n=m("workflows.reset");break;case k.Terminate:n=m("workflows.terminated");break;default:Eo(o)}return t?m("workflows.workflow-action-reason-placeholder-with-email",{action:n,email:t}):m("workflows.workflow-action-reason-placeholder",{action:n})},N=({action:o,reason:t,email:n})=>{const e=Io(o,n);return t?[t.trim(),e].join(" "):e},go=async(o,t,n=fetch,e=!1)=>{const r=t.query||xo(t,e);let i;try{i=decodeURIComponent(r)}catch{i=r}const c=e?"workflows.archived":"workflows";let a="";const l=s=>{var y,h;Y(s),(y=s==null?void 0:s.body)!=null&&y.message||s!=null&&s.status?a=((h=s==null?void 0:s.body)==null?void 0:h.message)??`Error fetching workflows: ${s.status}: ${s.statusText}`:a="Error fetching workflows: Server failed to respond"},f=w(c,{namespace:o}),{executions:u,nextPageToken:E}=await d(f,{params:{query:i},onError:l,handleError:l,request:n})??{executions:[],nextPageToken:""};return{workflows:V({executions:u}),nextPageToken:String(E),error:a}},Bo=async({namespace:o,workflowId:t,url:n},e=fetch)=>{var u;const r="workflows",i=n??M(o),c=X(r,{namespace:o}),a=i+c,{executions:l}=await d(a,{params:{query:`WorkflowId="${t}"`,pageSize:"1"},request:e})??{executions:[]},f=(u=V({executions:l}))==null?void 0:u[0];return{runId:f==null?void 0:f.runId}},Qo=async(o,t=fetch,n=!1)=>{const e=n?"workflows.archived":"workflows";let r=!0;const i=a=>{(Z(a)||oo(a))&&(r=!1)},c=w(e,{namespace:o});return await d(c,{params:{pageSize:"1"},onError:i,handleError:i,request:t}),{authorized:r}},Uo=async(o,t,n=fetch)=>go(o,t,n,!0);async function jo(o,t=fetch){const n=w("workflow",{namespace:o.namespace,workflowId:o.workflowId});return d(n,{request:t,notifyOnError:!1,params:{"execution.runId":o.runId}}).then(e=>({workflow:T(e)})).catch(e=>({error:e}))}async function Ko({workflow:o,namespace:t,reason:n}){const e=w("workflow.terminate",{namespace:t,workflowId:o.id}),r=x($).email,i=N({reason:n,action:k.Terminate,email:r});return await d(e,{options:{method:"POST",body:I({reason:i,...r&&{identity:r}})},notifyOnError:!1,params:{"execution.runId":o.runId}})}async function Do({namespace:o,workflow:{id:t,runId:n}},e=fetch){const r=w("workflow.cancel",{namespace:o,workflowId:t});return d(r,{request:e,notifyOnError:!1,options:{method:"POST"},params:{"execution.runId":n}})}async function Lo({namespace:o,workflow:{id:t,runId:n},name:e,input:r}){const i=w("workflow.signal",{namespace:o,workflowId:t,signalName:e}),c=await J(r),a=x(P).data.settings,l=(a==null?void 0:a.version)??"",u=v(l,"2.22")?{signalName:e,workflowExecution:{workflowId:t,runId:n},input:{payloads:c}}:{signalName:e,input:{payloads:c},params:{"execution.runId":n}};return d(i,{notifyOnError:!1,options:{method:"POST",body:I(u)}})}async function _o({namespace:o,workflow:{id:t,runId:n},eventId:e,reason:r,reapplyType:i}){const c=w("workflow.reset",{namespace:o,workflowId:t}),a=x($).email,l=N({action:k.Reset,reason:r,email:a}),f={workflowExecution:{workflowId:t,runId:n},workflowTaskFinishEventId:e,resetReapplyType:i,requestId:io(),reason:l};return d(c,{notifyOnError:!1,options:{method:"POST",body:I(f)},params:{"execution.runId":n}})}async function Go(o,t=fetch){const n=r=>{console.error(r)},e=w("workflow",o);return d(e,{request:t,onError:n,handleError:n}).then(T)}export{Qo as a,go as b,Do as c,Uo as d,xo as e,Bo as f,Lo as g,jo as h,Go as i,Io as j,z as k,_o as r,lo as s,Ko as t};
