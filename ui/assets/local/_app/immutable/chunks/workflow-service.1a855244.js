import{aj as h}from"./index.df672b57.js";import{t as q}from"./translate.fa4eeabe.js";import{a as Q,b as U}from"./decode-payload.d80a9967.js";import{f as D}from"./screaming-enums.485ed739.js";import{w as K}from"./write-actions-are-allowed.b0245323.js";import{s as N}from"./simplify-attributes.ba9d1331.js";import{l as _,a as L}from"./data-encoder-config.71b83e4d.js";import{B as J}from"./prod-browser.becde89a.js";import{b as G,p as H,a as l,r as w,c as M,i as X,d as Y}from"./route-for-api.a7e645b7.js";import{s as E}from"./parse-with-big-int.b2dd742c.js";import{h as x}from"./singletons.426f19a7.js";import{p as Z}from"./stores.1904ba37.js";import{i as oo}from"./version-check.d006b302.js";import{c as F,t as to}from"./versions.73be8806.js";import{i as no,h as ro,j as O,k as eo}from"./format-time.d2ca65b6.js";import{v as io}from"./toaster.be4ecbd4.js";const ao=(o=[])=>o.map(t=>{const n=N(t,!0),r=t.activityId;return{...n,id:r}}),co=o=>!o||!o.indexedFields?{}:{indexedFields:Object.entries(o.indexedFields).reduce((n,[r,e])=>({...n,[r]:Q(e)}),{})},I=o=>{var p,T,b,g,S,W,A;const t=co(o.workflowExecutionInfo.searchAttributes),n=o.workflowExecutionInfo.type.name,r=o.workflowExecutionInfo.execution.workflowId,e=o.workflowExecutionInfo.execution.runId,i=o.workflowExecutionInfo.startTime,s=o.workflowExecutionInfo.closeTime,a=o.workflowExecutionInfo.executionTime,f=D(o.workflowExecutionInfo.status),u=f==="Running",d=o.workflowExecutionInfo.historyLength,y=o.workflowExecutionInfo.historySizeBytes,c=`/workflows/${r}/${e}`,m=((T=(p=o==null?void 0:o.executionConfig)==null?void 0:p.taskQueue)==null?void 0:T.name)||((b=o==null?void 0:o.workflowExecutionInfo)==null?void 0:b.taskQueue),k=(g=o==null?void 0:o.workflowExecutionInfo)==null?void 0:g.mostRecentWorkerVersionStamp,P=(S=o==null?void 0:o.workflowExecutionInfo)==null?void 0:S.parentNamespaceId,v=(W=o==null?void 0:o.workflowExecutionInfo)==null?void 0:W.parentExecution,B=o.workflowExecutionInfo.stateTransitionCount,z=(A=o.executionConfig)==null?void 0:A.defaultWorkflowTaskTimeout,V=ao(o.pendingActivities),j=(o==null?void 0:o.pendingChildren)??[];return{name:n,id:r,runId:e,startTime:i,endTime:s,executionTime:a,status:f,historyEvents:d,historySizeBytes:y,searchAttributes:t,url:c,taskQueue:m,mostRecentWorkerVersionStamp:k,pendingActivities:V,pendingChildren:j,parentNamespaceId:P,parent:v,stateTransitionCount:B,isRunning:u,defaultWorkflowTaskTimeout:z,get canBeTerminated(){return u&&K()}}},R=o=>(o.executions||[]).map(t=>I({workflowExecutionInfo:t})),so=o=>window.btoa(encodeURIComponent(o).replace(/%([0-9A-F]{2})/g,(t,n)=>String.fromCharCode(parseInt(n,16)))),C=(o,t=J)=>t?so(o):o,fo=(o,t)=>{var n;return((n=o==null?void 0:o.visibilityStore)==null?void 0:n.includes("elasticsearch"))||oo(t,"1.19")},uo=o=>{var t;return(t=o==null?void 0:o.visibilityStore)==null?void 0:t.includes("elasticsearch")},$=x([Z],([o])=>{var t,n,r;return(r=(n=(t=o.data)==null?void 0:t.settings)==null?void 0:n.runtimeEnvironment)==null?void 0:r.isCloud}),lo=x([F,to,$],([o,t,n])=>fo(o,t)||n);x([F,$],([o,t])=>uo(o)||t);const wo={workflowId:"WorkflowId",workflowType:"WorkflowType",timeRange:"StartTime",executionStatus:"ExecutionStatus",closeTime:"CloseTime"},mo=["workflowId","workflowType","timeRange","executionStatus","closeTime"],ko=o=>!(o===null||o===void 0||o===""||typeof o=="string"&&o==="undefined"),yo=o=>{if(typeof o!="string")return!1;for(const t of mo)if(t===o)return!0;return!1},ho=(o,t,n)=>{const r=wo[o];return t==="All"?"":no(t)||ro(t)?n||h(lo)?`${r} > "${O(t)}"`:`${r} BETWEEN "${O(t)}" AND "${eo()}"`:`${r}="${t}"`},Eo=(o,t)=>Object.entries(o).map(([n,r])=>{if(yo(n)&&ko(r))return ho(n,r,t)}).filter(Boolean),xo=(o,t=!1)=>Eo(o,t).join(" and "),Io=async(o,t,n=fetch,r=!1)=>{const e=t.query||xo(t,r);let i;try{i=decodeURIComponent(e)}catch{i=e}const s=r?"workflows.archived":"workflows";let a="";const f=c=>{var m,k;M(c),(m=c==null?void 0:c.body)!=null&&m.message||c!=null&&c.status?a=((k=c==null?void 0:c.body)==null?void 0:k.message)??`Error fetching workflows: ${c.status}: ${c.statusText}`:a="Error fetching workflows: Server failed to respond"},u=w(s,{namespace:o}),{executions:d,nextPageToken:y}=await l(u,{params:{query:i},onError:f,handleError:f,request:n})??{executions:[],nextPageToken:""};return{workflows:R({executions:d}),nextPageToken:String(y),error:a}},Vo=async({namespace:o,workflowId:t,url:n},r=fetch)=>{var d;const e="workflows",i=n??G(o),s=H(e,{namespace:o}),a=i+s,{executions:f}=await l(a,{params:{query:`WorkflowId="${t}"`,pageSize:"1"},request:r})??{executions:[]},u=(d=R({executions:f}))==null?void 0:d[0];return{runId:u==null?void 0:u.runId}},jo=async(o,t=fetch,n=!1)=>{const r=n?"workflows.archived":"workflows";let e=!0;const i=a=>{(X(a)||Y(a))&&(e=!1)},s=w(r,{namespace:o});return await l(s,{params:{pageSize:"1"},onError:i,handleError:i,request:t}),{authorized:e}},qo=async(o,t,n=fetch)=>Io(o,t,n,!0);async function Qo(o,t=fetch){const n=w("workflow",{namespace:o.namespace,workflowId:o.workflowId});return l(n,{request:t,notifyOnError:!1,params:{"execution.runId":o.runId}}).then(r=>({workflow:I(r)})).catch(r=>({error:r}))}async function Uo({workflow:o,namespace:t,reason:n,identity:r}){const e=w("workflow.terminate",{namespace:t,workflowId:o.id});return await l(e,{options:{method:"POST",body:E({reason:n,...r&&{identity:r}})},notifyOnError:!1,params:{"execution.runId":o.runId}})}async function Do({namespace:o,workflowId:t,runId:n},r=fetch){const e=w("workflow.cancel",{namespace:o,workflowId:t});return l(e,{request:r,notifyOnError:!1,options:{method:"POST"},params:{"execution.runId":n}})}async function Ko({namespace:o,workflowId:t,runId:n,signalName:r,signalInput:e,settings:i,accessToken:s}){var u;const a=w("workflow.signal",{namespace:o,workflowId:t,signalName:r});let f=null;if(e)if((u=i==null?void 0:i.codec)!=null&&u.endpoint){const d=await U({payloads:{payloads:[JSON.parse(e)]},namespace:o,settings:i,accessToken:s,encode:!0});if(h(_)==="error")throw new Error(h(L)||q("common.encode-failed"));f=(d==null?void 0:d.payloads)??null}else f=[{metadata:{encoding:C("json/plain")},data:C(e)}];return l(a,{notifyOnError:!1,options:{method:"POST",body:E({signalName:r,input:{payloads:f},params:{"execution.runId":n}})}})}async function No({namespace:o,workflowId:t,runId:n,eventId:r,reason:e,resetReapplyType:i}){const s=w("workflow.reset",{namespace:o,workflowId:t}),a={workflowExecution:{workflowId:t,runId:n},workflowTaskFinishEventId:r,resetReapplyType:i,requestId:io(),reason:e};return l(s,{notifyOnError:!1,options:{method:"POST",body:E(a)},params:{"execution.runId":n}})}async function _o(o,t=fetch){const n=e=>{console.error(e)},r=w("workflow",o);return l(r,{request:t,onError:n,handleError:n}).then(I)}export{jo as a,qo as b,Do as c,xo as d,_o as e,Qo as f,lo as g,Io as h,$ as i,Vo as j,No as r,Ko as s,Uo as t};
