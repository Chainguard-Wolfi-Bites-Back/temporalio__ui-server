var $=Object.defineProperty,D=Object.defineProperties;var G=Object.getOwnPropertyDescriptors;var R=Object.getOwnPropertySymbols;var M=Object.prototype.hasOwnProperty,K=Object.prototype.propertyIsEnumerable;var F=(t,i,e)=>i in t?$(t,i,{enumerable:!0,configurable:!0,writable:!0,value:e}):t[i]=e,b=(t,i)=>{for(var e in i||(i={}))M.call(i,e)&&F(t,e,i[e]);if(R)for(var e of R(i))K.call(i,e)&&F(t,e,i[e]);return t},q=(t,i)=>D(t,G(i));import{at as _,aH as B}from"./vendor-f1345faf.js";import{s as A,d as H,a as L}from"./data-converter-config-66ab2237.js";import{a as j}from"./atob-5f9d7101.js";import{f as U}from"./format-date-4fd39826.js";import{g as V}from"./get-event-categorization-90555be0.js";const z=(t,i)=>{if(!t)return{hasWebsocket:!1,websocket:null,closeSocket:function(){return null}};try{v=new B(`ws://localhost:${t}/`,b({packMessage:e=>JSON.stringify(e),unpackMessage:e=>JSON.parse(e),attachRequestId:(e,r)=>Object.assign({requestId:r},e),extractRequestId:e=>e&&e.requestId},i)),v.onError(()=>{console.error("A WebSocket error occurred.")})}catch{A()}return v.open(),{hasWebsocket:!0,websocket:v,closeSocket:function(){return v.close()}}};let v=null;var N;const Q=(N=_(H))!=null?N:null,X=z(Q);async function Y(t,i){if(!i.isOpened)try{await i.open()}catch{A()}return i.isOpened?i.sendRequest({payload:JSON.stringify(t)}).then(r=>{L();try{return JSON.parse(r.content)}catch{return r.content}}).catch(()=>{A()}):Promise.resolve(t)}function m(t){var e,r;const i=j(String((r=(e=t==null?void 0:t.metadata)==null?void 0:e.encoding)!=null?r:""));switch(t.metadata.encodingDecoded=i,i){case"json/plain":case"json/protobuf":try{return JSON.parse(j(String(t.data)))}catch{}}return t}const Z=async(t,i)=>{var o,c,a,d,l,k,x,C,y,W,I,O;const e=t,r=(d=(a=(o=e==null?void 0:e.input)==null?void 0:o.payloads)!=null?a:(c=e==null?void 0:e.result)==null?void 0:c.payloads)!=null?d:null;if(r){let n;const u=i!=null?i:X;(i==null?void 0:i.hasWebsocket)?n=await Promise.all((r!=null?r:[]).map(async P=>await Y(P,u.websocket))):n=r.map(m),((l=e==null?void 0:e.input)==null?void 0:l.payloads)&&(e.input.payloads=n),((k=e==null?void 0:e.result)==null?void 0:k.payloads)&&(e.result.payloads=n)}if((x=e==null?void 0:e.searchAttributes)==null?void 0:x.indexedFields){const n=(C=e==null?void 0:e.searchAttributes)==null?void 0:C.indexedFields;Object.entries(n).forEach(([u,E])=>{n[u]=m(E)})}if((y=e==null?void 0:e.memo)==null?void 0:y.fields){const n=(W=e==null?void 0:e.memo)==null?void 0:W.fields;Object.entries(n).forEach(([u,E])=>{n[u]=m(E)})}if((I=e==null?void 0:e.header)==null?void 0:I.fields){const n=(O=e==null?void 0:e.header)==null?void 0:O.fields;Object.entries(n).forEach(([u,E])=>{n[u]=m(E)})}if(e==null?void 0:e.queryResult){const n=e==null?void 0:e.queryResult;Object.entries(n).forEach(([u,E])=>{n[u]=m(E)})}return e},tt=["workflowExecutionStartedEventAttributes","workflowExecutionCompletedEventAttributes","workflowExecutionFailedEventAttributes","workflowExecutionTimedOutEventAttributes","workflowTaskStartedEventAttributes","workflowTaskScheduledEventAttributes","workflowTaskCompletedEventAttributes","workflowTaskTimedOutEventAttributes","workflowTaskFailedEventAttributes","activityTaskScheduledEventAttributes","activityTaskCompletedEventAttributes","activityTaskStartedEventAttributes","activityTaskFailedEventAttributes","activityTaskTimedOutEventAttributes","timerStartedEventAttributes","timerFiredEventAttributes","activityTaskCancelRequestedEventAttributes","activityTaskCanceledEventAttributes","timerCanceledEventAttributes","markerRecordedEventAttributes","workflowExecutionSignaledEventAttributes","workflowExecutionTerminatedEventAttributes","workflowExecutionCancelRequestedEventAttributes","workflowExecutionCanceledEventAttributes","requestCancelExternalWorkflowExecutionInitiatedEventAttributes","requestCancelExternalWorkflowExecutionFailedEventAttributes","externalWorkflowExecutionCancelRequestedEventAttributes","workflowExecutionContinuedAsNewEventAttributes","startChildWorkflowExecutionInitiatedEventAttributes","startChildWorkflowExecutionFailedEventAttributes","childWorkflowExecutionStartedEventAttributes","childWorkflowExecutionCompletedEventAttributes","childWorkflowExecutionFailedEventAttributes","childWorkflowExecutionCanceledEventAttributes","childWorkflowExecutionTimedOutEventAttributes","childWorkflowExecutionTerminatedEventAttributes","signalExternalWorkflowExecutionInitiatedEventAttributes","signalExternalWorkflowExecutionFailedEventAttributes","externalWorkflowExecutionSignaledEventAttributes","upsertWorkflowSearchAttributesEventAttributes"],et=t=>{for(const i of tt)if(i in t)return i},it=(t,i)=>t[i],rt=t=>{const i=et(t),e=it(t,i);return{key:i,attributes:e}},s=t=>i=>Boolean(i[t]),w=s("activityTaskScheduledEventAttributes"),nt=s("activityTaskStartedEventAttributes"),st=s("activityTaskCompletedEventAttributes"),ot=s("activityTaskFailedEventAttributes"),ct=s("activityTaskTimedOutEventAttributes"),S=s("timerStartedEventAttributes"),at=s("timerFiredEventAttributes"),ut=s("activityTaskCancelRequestedEventAttributes"),dt=s("activityTaskCanceledEventAttributes"),lt=s("timerCanceledEventAttributes"),p=s("markerRecordedEventAttributes"),T=s("workflowExecutionSignaledEventAttributes"),g=s("startChildWorkflowExecutionInitiatedEventAttributes"),Et=s("childWorkflowExecutionStartedEventAttributes"),ft=s("childWorkflowExecutionCompletedEventAttributes"),h=s("signalExternalWorkflowExecutionInitiatedEventAttributes"),J=t=>{if(w(t)||g(t)||S(t)||h(t)||T(t)||p(t))return t.id;if(nt(t))return String(t.activityTaskStartedEventAttributes.scheduledEventId);if(dt(t))return String(t.activityTaskCanceledEventAttributes.scheduledEventId);if(ut(t))return String(t.activityTaskCancelRequestedEventAttributes.scheduledEventId);if(ot(t))return String(t.activityTaskFailedEventAttributes.scheduledEventId);if(ct(t))return String(t.activityTaskTimedOutEventAttributes.scheduledEventId);if(st(t))return String(t.activityTaskCompletedEventAttributes.scheduledEventId);if(Et(t))return String(t.childWorkflowExecutionStartedEventAttributes.initiatedEventId);if(ft(t))return String(t.childWorkflowExecutionCompletedEventAttributes.initiatedEventId);if(at(t))return String(t.timerFiredEventAttributes.startedEventId);if(lt(t))return String(t.timerCanceledEventAttributes.startedEventId)},kt=t=>{var i,e,r,o,c,a,d,l,k;if(!!t){if(w(t))return(e=(i=t.activityTaskScheduledEventAttributes)==null?void 0:i.activityType)==null?void 0:e.name;if(S(t))return`Timer ${(r=t.timerStartedEventAttributes)==null?void 0:r.timerId} (${(o=t.timerStartedEventAttributes)==null?void 0:o.startToFireTimeout})`;if(h(t))return`Signal: ${(c=t.signalExternalWorkflowExecutionInitiatedEventAttributes)==null?void 0:c.signalName}`;if(T(t))return`Signal received: ${(a=t.workflowExecutionSignaledEventAttributes)==null?void 0:a.signalName}`;if(p(t))return`Marker: ${(d=t.markerRecordedEventAttributes)==null?void 0:d.markerName}`;if(g(t))return`Child Workflow: ${(k=(l=t.startChildWorkflowExecutionInitiatedEventAttributes)==null?void 0:l.workflowType)==null?void 0:k.name}`}},f=t=>{const i=J(t),e=kt(t),{timestamp:r,category:o,classification:c}=t,a=t,d=new Map,l=new Set;return d.set(t.id,t),l.add(t.id),{id:i,name:e,events:d,eventIds:l,initialEvent:a,timestamp:r,category:o,classification:c}},vt=t=>{if(w(t)||g(t)||S(t)||h(t)||T(t)||p(t))return f(t)},mt=(t,i)=>{!t||(t.events.set(i.id,i),t.eventIds.add(i.id),t.timestamp=i.timestamp)},bt=t=>{const i={};for(const e of t){const r=J(e),o=vt(e);o?i[o.id]=o:mt(i[r],e)}return Object.values(i)},At=["Unspecified","Scheduled","Open","New","Started","Initiated","Running","Completed","Fired","CancelRequested","TimedOut","Signaled","Canceled","Failed","Terminated"],wt=t=>{if(t.includes("RequestCancel"))return"CancelRequested";for(const i of At)if(t.includes(i))return i},St=t=>{if(t===null||t===void 0||typeof t!="object")return!1;const i=Object.keys(t),[e]=i;return!(i.length!==1||typeof t[e]!="string")},pt=t=>{for(const i of Object.values(t))return i},Tt=t=>{for(const[i,e]of Object.entries(t))St(e)&&(t[i]=pt(e));return t};async function gt(t){const{key:i,attributes:e}=rt(t),r=await Z(e);return b({type:i},r)}const ht=async t=>{const i=String(t.eventId),e=t.eventType,r=U(String(t.eventTime)),o=wt(e),c=V(e),a=await gt(t).then(Tt);return q(b({},t),{attributes:a,eventType:e,classification:o,category:c,id:i,name:e,timestamp:r})},Rt=async t=>{const i=await Promise.all(t.map(ht)),e=bt(i);return{events:i,eventGroups:e}};export{Rt as t};
